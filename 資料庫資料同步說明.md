# 資料庫資料同步說明

## 目標

確保所有環境的資料庫**結構**和**資料內容**都完全一致。

## 資料同步方式

### 方式 1：使用 seed.sql（推薦）

`seed.sql` 文件會在執行 `supabase db reset` 時自動執行，確保資料內容一致。

#### 步驟 1：導出當前資料庫的資料

**方法 A：使用 SQL 查詢（推薦）**

1. 打開 Supabase Studio：`http://localhost:54323`
2. 進入 SQL Editor
3. 打開 `生成資料導出SQL.sql` 文件
4. 執行對應的 SELECT 查詢：
   - 執行 roles 表的查詢
   - 執行 users 表的查詢
   - 執行 tasks 表的查詢
5. 複製查詢結果（INSERT 語句）
6. 貼到 `supabase/seed.sql` 文件中對應的位置

**方法 B：使用批處理腳本**

執行 `導出資料庫資料_完整版.bat`，它會：
- 生成 seed.sql 範本
- 提供詳細的導出說明

#### 步驟 2：更新 seed.sql

將導出的 INSERT 語句貼到 `supabase/seed.sql` 中，格式如下：

```sql
-- 插入 roles 表資料
INSERT INTO roles (id, name, icon_name, color, level, webhook, is_default, created_at, updated_at)
VALUES 
  ('role1', '角色名稱1', 'Briefcase', 'bg-blue-100 text-blue-700', 4, NULL, false, NOW(), NOW())
ON CONFLICT (id) DO UPDATE SET
  name = EXCLUDED.name,
  icon_name = EXCLUDED.icon_name,
  color = EXCLUDED.color,
  level = EXCLUDED.level,
  webhook = EXCLUDED.webhook,
  is_default = EXCLUDED.is_default,
  updated_at = EXCLUDED.updated_at;

-- 插入 users 表資料
INSERT INTO users (id, name, role, level, mail, employee_id, headshot)
VALUES 
  (1, '使用者名稱', 'role1', 4, 'email@example.com', 'EMP001', NULL)
ON CONFLICT (id) DO UPDATE SET
  name = EXCLUDED.name,
  role = EXCLUDED.role,
  level = EXCLUDED.level,
  mail = EXCLUDED.mail,
  employee_id = EXCLUDED.employee_id,
  headshot = EXCLUDED.headshot;

-- 插入 tasks 表資料
INSERT INTO tasks (id, title, description, assigner_id, assignee_id, role_category, status, evidence, created_at, updated_at)
VALUES 
  (1, '任務標題', '任務描述', 1, 2, 'role1', 'pending', '{}', NOW(), NOW())
ON CONFLICT (id) DO UPDATE SET
  title = EXCLUDED.title,
  description = EXCLUDED.description,
  assigner_id = EXCLUDED.assigner_id,
  assignee_id = EXCLUDED.assignee_id,
  role_category = EXCLUDED.role_category,
  status = EXCLUDED.status,
  evidence = EXCLUDED.evidence,
  updated_at = EXCLUDED.updated_at;
```

**重要：**
- 使用 `ON CONFLICT` 避免重複插入
- 資料順序很重要：先 roles，再 users，最後 tasks（因為外鍵關聯）

#### 步驟 3：在其他環境中執行

```bash
# 重置資料庫（會執行所有 migrations 和 seed.sql）
supabase db reset

# 或只執行 seed.sql（如果 migrations 已執行）
supabase db seed
```

### 方式 2：使用 Migration 文件

如果資料是結構的一部分（例如預設角色），可以寫在 migration 文件中。

**優點：**
- 資料會隨著結構一起遷移
- 不需要單獨執行 seed

**缺點：**
- 不適合大量資料
- 每次遷移都會執行

**範例：**

在 migration 文件中：

```sql
-- 創建表
CREATE TABLE roles (...);

-- 插入預設資料
INSERT INTO roles (id, name, icon_name, color, level, is_default)
VALUES 
  ('admin', '管理員', 'Shield', 'bg-red-100 text-red-700', 1, true),
  ('manager', '經理', 'Briefcase', 'bg-blue-100 text-blue-700', 2, false)
ON CONFLICT (id) DO NOTHING;
```

## 完整流程

### 開發環境（導出資料）

1. **確保資料是最新的**
   ```bash
   # 在開發環境中確認資料
   supabase studio
   ```

2. **導出資料**
   ```bash
   # 執行導出腳本
   導出資料庫資料_完整版.bat
   
   # 或手動執行 SQL 查詢
   # 打開「生成資料導出SQL.sql」並執行查詢
   ```

3. **更新 seed.sql**
   - 將導出的 INSERT 語句貼到 `supabase/seed.sql`
   - 確保使用 `ON CONFLICT` 避免重複

4. **提交到 Git**
   ```bash
   git add supabase/seed.sql
   git commit -m "更新資料庫種子資料"
   git push
   ```

### 其他環境（導入資料）

1. **拉取代碼**
   ```bash
   git pull
   ```

2. **重置資料庫**
   ```bash
   # 這會執行所有 migrations 和 seed.sql
   supabase db reset
   ```

3. **驗證資料**
   ```sql
   -- 在 Supabase Studio SQL Editor 中執行
   SELECT COUNT(*) FROM roles;
   SELECT COUNT(*) FROM users;
   SELECT COUNT(*) FROM tasks;
   ```

## 資料更新流程

當資料有變更時：

1. **更新開發環境的資料**
   - 在 Supabase Studio 中手動修改
   - 或通過應用程式修改

2. **重新導出資料**
   ```bash
   導出資料庫資料_完整版.bat
   ```

3. **更新 seed.sql**
   - 將新的 INSERT 語句貼到 seed.sql

4. **提交並推送**
   ```bash
   git add supabase/seed.sql
   git commit -m "更新資料庫資料：..."
   git push
   ```

5. **其他環境更新**
   ```bash
   git pull
   supabase db reset  # 或 supabase db seed
   ```

## 注意事項

1. **資料順序**
   - 必須先插入 roles，再插入 users，最後插入 tasks
   - 因為有外鍵關聯

2. **使用 ON CONFLICT**
   - 避免重複插入
   - 允許更新現有資料

3. **敏感資料**
   - 不要將敏感資料（如密碼、API Key）寫入 seed.sql
   - 使用環境變數或配置管理

4. **大量資料**
   - 如果資料量很大，考慮使用 CSV 導入
   - 或使用 `COPY` 命令

5. **測試**
   - 在測試環境中先測試 seed.sql
   - 確認資料正確後再推送到生產環境

## 檢查清單

- [ ] 已導出當前資料庫的所有資料
- [ ] 已更新 seed.sql 文件
- [ ] 已測試 seed.sql 在乾淨環境中執行
- [ ] 已提交 seed.sql 到 Git
- [ ] 已通知其他開發者更新資料

## 相關文件

- `生成資料導出SQL.sql` - SQL 查詢範本
- `導出資料庫資料_完整版.bat` - 自動導出腳本
- `supabase/seed.sql` - 種子資料文件
