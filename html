import React, { useState, useEffect, useMemo } from 'react';
import { 
  Users, 
  Calendar, 
  Mic, 
  Bot, 
  FileText, 
  CheckCircle, 
  AlertCircle, 
  Clock, 
  ChevronDown, 
  ChevronUp, 
  Plus, 
  BarChart3, 
  Upload, 
  Image as ImageIcon,
  Activity,
  Stethoscope,
  HeartPulse,
  Briefcase,
  Link as LinkIcon,
  ExternalLink,
  FolderOpen,
  X
} from 'lucide-react';

// --- Mock Data & Constants ---

const ROLES = [
  { id: 'medical_admin', name: 'é†«å‹™å°ˆå“¡', icon: Briefcase, color: 'bg-blue-100 text-blue-700' },
  { id: 'nurse', name: 'è­·ç†å¸«', icon: HeartPulse, color: 'bg-pink-100 text-pink-700' },
  { id: 'ward_ops', name: 'ç—…æˆ¿æ¥­å‹™', icon: Activity, color: 'bg-green-100 text-green-700' },
  { id: 'social_worker', name: 'ç¤¾å·¥å¸«', icon: Users, color: 'bg-orange-100 text-orange-700' },
  { id: 'ot', name: 'è·èƒ½æ²»ç™‚å¸«', icon: Stethoscope, color: 'bg-purple-100 text-purple-700' },
];

const USERS = [
  { id: 1, name: 'é™³ä¸»ä»»', role: 'medical_admin', avatar: 'ğŸ‘¨â€âš•ï¸' },
  { id: 2, name: 'æ—è­·ç†é•·', role: 'nurse', avatar: 'ğŸ‘©â€âš•ï¸' },
  { id: 3, name: 'å¼µç¤¾å·¥', role: 'social_worker', avatar: 'ğŸ§‘â€ğŸ’¼' },
  { id: 4, name: 'ç‹æ²»ç™‚å¸«', role: 'ot', avatar: 'ğŸ§˜' },
  { id: 5, name: 'æå°ˆå“¡', role: 'ward_ops', avatar: 'ğŸ‘¨â€ğŸ’¼' },
  { id: 6, name: 'å³å”èª¿å“¡', role: 'medical_admin', avatar: 'ğŸ‘©â€ğŸ’¼' },
];

const INITIAL_TASKS = [
  {
    id: 101,
    title: 'Q4 ç—…æˆ¿æ»¿æ„åº¦èª¿æŸ¥åˆ†æ',
    description: '1. æ”¶é›†å„ç—…æˆ¿ç´™æœ¬å•å·ã€‚\n2. æ•¸ä½åŒ–æ•¸æ“šä¸¦åŒ¯å…¥ç³»çµ±ã€‚\n3. é‡å°ä½åˆ†é …ç›®æå‡ºæ”¹å–„è¨ˆç•«ã€‚',
    assignerId: 1,
    assigneeId: 5,
    collaboratorIds: [2, 3],
    roleCategory: 'ward_ops',
    dates: {
      plan: '2023-10-25',
      interim: '2023-11-05',
      final: '2023-11-15'
    },
    status: 'in_progress', // pending, in_progress, done, overdue
    assigneeResponse: 'ç›®å‰å·²å›æ”¶80%å•å·ï¼Œçµ±è¨ˆåœ–è¡¨å·²ç”¢å‡ºï¼Œè«‹è¦‹é™„ä»¶ã€‚',
    evidence: [
      { id: 'e1', type: 'stat', label: 'å•å·å›æ”¶ç‡', value: '82%', trend: 'up' },
      { id: 'e2', type: 'stat', label: 'æ•´é«”æ»¿æ„åº¦', value: '4.5', sub: '/ 5.0' },
      { id: 'e3', type: 'image', name: 'æ»¿æ„åº¦é•·æ¢åœ–.png', url: 'https://via.placeholder.com/300x200?text=Chart+Preview' },
      { id: 'e4', type: 'link', name: 'åŸå§‹æ•¸æ“š_GoogleDrive', url: 'https://drive.google.com/drive/folders/...' }
    ]
  },
  {
    id: 102,
    title: 'è·èƒ½æ²»ç™‚å®¤è¨­å‚™æ›´æ–°è©•ä¼°',
    description: 'è©•ä¼°ç¾æœ‰å¾©å¥å™¨ææŠ˜èˆŠç‹€æ³ï¼Œä¸¦å°‹æ‰¾ä¸‰å®¶å» å•†å ±åƒ¹ã€‚',
    assignerId: 1,
    assigneeId: 4,
    collaboratorIds: [],
    roleCategory: 'ot',
    dates: {
      plan: '2023-10-01',
      interim: '2023-10-10',
      final: '2023-10-20'
    },
    status: 'overdue',
    assigneeResponse: 'å» å•†å ±åƒ¹å–®å·²ä¸Šå‚³è‡³å…±ç”¨è³‡æ–™å¤¾ã€‚',
    evidence: [
        { id: 'e5', type: 'link', name: 'å» å•†å ±åƒ¹å–®è³‡æ–™å¤¾', url: '#' }
    ]
  },
    {
    id: 103,
    title: 'å±…å®¶è­·ç†è¨ªè¦–æµç¨‹å„ªåŒ–',
    description: 'é‡å°å‡ºé™¢å¾Œ72å°æ™‚å…§çš„è¨ªè¦–æµç¨‹é€²è¡ŒSOPä¿®è¨‚ã€‚',
    assignerId: 2,
    assigneeId: 2,
    collaboratorIds: [3],
    roleCategory: 'nurse',
    dates: {
      plan: '2023-11-01',
      interim: '2023-11-10',
      final: '2023-11-20'
    },
    status: 'done',
    assigneeResponse: 'å·²å®ŒæˆSOP v2.0ç‰ˆè‰æ¡ˆï¼Œç¶“æœƒè­°é€šéã€‚',
    evidence: [
        { id: 'e6', type: 'image', name: 'æ–°ç‰ˆæµç¨‹åœ–_v2.jpg', url: 'https://via.placeholder.com/300x400?text=SOP+Flowchart' }
    ]
  }
];

// --- Utility Functions ---

const getStatusColor = (task) => {
  const today = new Date().toISOString().split('T')[0];
  if (task.status === 'done') return 'bg-emerald-50 text-emerald-900 border-emerald-200';
  if (task.dates.final < today && task.status !== 'done') return 'bg-red-50 text-red-900 border-red-200';
  if (task.status === 'in_progress') return 'bg-blue-50 text-blue-900 border-blue-200';
  return 'bg-gray-50 text-gray-800 border-gray-200'; // Pending
};

const getStatusLabel = (task) => {
  const today = new Date().toISOString().split('T')[0];
  if (task.status === 'done') return 'å·²å®Œæˆ';
  if (task.dates.final < today && task.status !== 'done') return 'å·²é€¾æœŸ';
  if (task.status === 'in_progress') return 'é€²è¡Œä¸­';
  return 'å¾…è™•ç†';
};

// --- Components ---

const UserSelector = ({ label, users, selectedId, onSelect, multiple = false, selectedIds = [] }) => {
  const handleSelect = (id) => {
    if (multiple) {
      if (selectedIds.includes(id)) {
        onSelect(selectedIds.filter(uid => uid !== id));
      } else {
        onSelect([...selectedIds, id]);
      }
    } else {
      onSelect(id);
    }
  };

  return (
    <div className="mb-4">
      <label className="block text-sm font-medium text-slate-700 mb-2">{label}</label>
      <div className="flex flex-wrap gap-2">
        {users.map(user => {
            const isSelected = multiple ? selectedIds.includes(user.id) : selectedId === user.id;
            return (
                <button
                    key={user.id}
                    onClick={() => handleSelect(user.id)}
                    className={`flex items-center space-x-1 px-3 py-2 rounded-full border transition-all ${
                    isSelected
                        ? 'bg-indigo-600 text-white border-indigo-600 shadow-md transform scale-105'
                        : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'
                    }`}
                >
                    <span className="text-lg">{user.avatar}</span>
                    <span className="text-sm font-medium">{user.name}</span>
                    {isSelected && <CheckCircle size={14} className="ml-1" />}
                </button>
            )
        })}
      </div>
    </div>
  );
};

const EvidenceDisplay = ({ evidence, onDelete }) => {
    if (!evidence) return null;

    if (evidence.type === 'stat') {
        return (
            <div className="bg-white border border-slate-200 rounded-lg p-3 flex flex-col items-center justify-center min-w-[120px] shadow-sm relative group">
                {onDelete && <button onClick={onDelete} className="absolute top-1 right-1 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><X size={14}/></button>}
                <div className="text-xs text-slate-500 mb-1">{evidence.label}</div>
                <div className="text-2xl font-bold text-indigo-600 flex items-baseline">
                    {evidence.value}
                    {evidence.sub && <span className="text-xs text-slate-400 ml-1 font-normal">{evidence.sub}</span>}
                </div>
                {evidence.trend && <div className="text-xs text-emerald-500 flex items-center mt-1">â–² è¼ƒä¸Šæœˆæˆé•·</div>}
            </div>
        );
    }

    if (evidence.type === 'link') {
        return (
            <a href={evidence.url} target="_blank" rel="noreferrer" className="flex items-center bg-blue-50 border border-blue-100 rounded-lg p-3 text-blue-700 hover:bg-blue-100 transition-colors relative group min-w-[200px]">
                {onDelete && (
                    <button 
                        onClick={(e) => { e.preventDefault(); onDelete(); }} 
                        className="absolute top-1 right-1 text-blue-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity z-10"
                    >
                        <X size={14}/>
                    </button>
                )}
                <div className="bg-white p-2 rounded-full mr-3 shadow-sm">
                    {evidence.name.includes('Folder') || evidence.name.includes('è³‡æ–™å¤¾') ? <FolderOpen size={20} className="text-blue-500"/> : <LinkIcon size={20} className="text-blue-500"/>}
                </div>
                <div className="flex-1 overflow-hidden">
                    <div className="text-xs text-blue-400 font-bold mb-0.5">Google Drive / é€£çµ</div>
                    <div className="text-sm font-medium truncate w-full">{evidence.name}</div>
                </div>
                <ExternalLink size={14} className="ml-2 opacity-50"/>
            </a>
        );
    }

    if (evidence.type === 'image') {
        return (
            <div className="relative group rounded-lg overflow-hidden border border-slate-200 shadow-sm">
                <img src={evidence.url} alt={evidence.name} className="h-24 w-full object-cover transition-transform group-hover:scale-105" />
                <div className="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all pointer-events-none"/>
                {onDelete && (
                    <button 
                        onClick={onDelete} 
                        className="absolute top-1 right-1 bg-white rounded-full p-1 text-slate-400 hover:text-red-500 shadow opacity-0 group-hover:opacity-100 transition-opacity"
                    >
                        <X size={14}/>
                    </button>
                )}
                <div className="absolute bottom-0 left-0 right-0 bg-white bg-opacity-90 px-2 py-1 text-xs truncate border-t">
                    {evidence.name}
                </div>
            </div>
        );
    }
    return null;
};

const TaskCard = ({ task, users, onUpdateStatus, onUpdateResponse, onAddEvidence, onDeleteEvidence }) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [responseEdit, setResponseEdit] = useState(task.assigneeResponse || '');
  const [isEditingResponse, setIsEditingResponse] = useState(false);

  const assigner = users.find(u => u.id === task.assignerId);
  const assignee = users.find(u => u.id === task.assigneeId);
  const collaborators = users.filter(u => task.collaboratorIds.includes(u.id));

  const handleSaveResponse = () => {
    onUpdateResponse(task.id, responseEdit);
    setIsEditingResponse(false);
  };

  return (
    <div className={`mb-4 rounded-xl border-l-4 shadow-sm bg-white transition-all ${getStatusColor(task)} border-l-${getStatusColor(task).split('-')[1]}-500`}>
      <div className="p-4">
        {/* Header */}
        <div className="flex justify-between items-start mb-3 cursor-pointer" onClick={() => setIsExpanded(!isExpanded)}>
          <div className="flex-1">
            <div className="flex items-center space-x-2 mb-1">
                <span className={`text-xs px-2 py-0.5 rounded border font-bold ${getStatusColor(task).replace('bg-white', '')}`}>
                    {getStatusLabel(task)}
                </span>
                <span className="text-xs text-slate-500 bg-slate-100 px-2 py-0.5 rounded">
                    {ROLES.find(r => r.id === task.roleCategory)?.name || 'æœªåˆ†é¡'}
                </span>
            </div>
            <h3 className="text-lg font-bold text-slate-800">{task.title}</h3>
          </div>
          <button className="text-slate-400 hover:text-slate-600 ml-2">
            {isExpanded ? <ChevronUp /> : <ChevronDown />}
          </button>
        </div>

        {/* Quick People View */}
        <div className="flex items-center space-x-4 text-sm text-slate-600 mb-4 bg-white bg-opacity-50 p-2 rounded-lg border border-slate-100">
          <div className="flex items-center" title="äº¤è¾¦äºº">
            <span className="text-xs text-slate-400 mr-1">äº¤è¾¦:</span>
            <span>{assigner?.avatar} {assigner?.name}</span>
          </div>
          <div className="w-px h-4 bg-slate-300"></div>
          <div className="flex items-center" title="æ‰¿è¾¦äºº">
            <span className="text-xs text-slate-400 mr-1">æ‰¿è¾¦:</span>
            <span>{assignee?.avatar} {assignee?.name}</span>
          </div>
        </div>

        {/* Dates Preview (Always visible) */}
        <div className="grid grid-cols-3 gap-2 mb-2 text-xs">
            <div className="bg-white p-2 rounded border border-slate-100 text-center">
                <div className="text-slate-400 mb-0.5 text-[10px]">è¨ˆç•«</div>
                <div className="font-semibold text-slate-700">{task.dates.plan}</div>
            </div>
            <div className="bg-white p-2 rounded border border-orange-100 text-center">
                <div className="text-slate-400 mb-0.5 text-[10px]">æœŸä¸­</div>
                <div className="font-semibold text-orange-600">{task.dates.interim}</div>
            </div>
            <div className="bg-white p-2 rounded border border-red-100 text-center">
                <div className="text-slate-400 mb-0.5 text-[10px]">æœ€çµ‚</div>
                <div className="font-semibold text-red-600">{task.dates.final}</div>
            </div>
        </div>

        {/* Expandable Content */}
        {isExpanded && (
          <div className="mt-4 border-t pt-4 space-y-6 animate-fade-in">
            
            {/* 1. Task Description */}
            <div className="bg-slate-50 p-3 rounded-lg border border-slate-100">
                <h4 className="text-xs font-bold text-slate-500 mb-2 flex items-center uppercase tracking-wider">
                    <Bot size={14} className="mr-1 text-indigo-500"/> ä»»å‹™èªªæ˜ (AI ç”Ÿæˆ)
                </h4>
                <div className="text-sm text-slate-700 whitespace-pre-line leading-relaxed pl-1">
                    {task.description}
                </div>
            </div>

            {/* 2. Assignee Response */}
            <div>
                <h4 className="text-xs font-bold text-slate-500 mb-2 flex items-center justify-between uppercase tracking-wider">
                    <span className="flex items-center">
                        <Users size={14} className="mr-1 text-emerald-600"/> 
                        æ‰¿è¾¦äººå›è¦†
                    </span>
                    {!isEditingResponse && (
                        <button 
                            onClick={() => setIsEditingResponse(true)}
                            className="text-xs text-indigo-600 hover:text-indigo-800 font-medium"
                        >
                            ç·¨è¼¯å…§å®¹
                        </button>
                    )}
                </h4>
                
                {isEditingResponse ? (
                    <div className="space-y-2">
                        <textarea 
                            className="w-full p-2 border rounded-md text-sm focus:ring-2 focus:ring-emerald-500"
                            rows={3}
                            value={responseEdit}
                            onChange={(e) => setResponseEdit(e.target.value)}
                            placeholder="è«‹è¼¸å…¥è¾¦ç†æ­¥é©Ÿ..."
                        />
                        <div className="flex justify-end space-x-2">
                            <button 
                                onClick={() => setIsEditingResponse(false)}
                                className="px-3 py-1 text-xs text-slate-500 hover:bg-slate-100 rounded"
                            >
                                å–æ¶ˆ
                            </button>
                            <button 
                                onClick={handleSaveResponse}
                                className="px-3 py-1 text-xs bg-emerald-600 text-white rounded hover:bg-emerald-700"
                            >
                                å„²å­˜
                            </button>
                        </div>
                    </div>
                ) : (
                    <div 
                        className="bg-white border border-slate-200 p-3 rounded-lg text-sm text-slate-600 min-h-[50px] cursor-pointer hover:border-emerald-300 transition-colors"
                        onClick={() => setIsEditingResponse(true)}
                    >
                        {task.assigneeResponse || <span className="text-slate-400 italic">é»æ“Šæ­¤è™•è¼¸å…¥åŸ·è¡Œæ­¥é©Ÿ...</span>}
                    </div>
                )}
            </div>

            {/* 3. Evidence & Stats (Key Feature Update) */}
            <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                <h4 className="text-xs font-bold text-slate-700 mb-3 flex items-center justify-between uppercase tracking-wider">
                    <span className="flex items-center">
                        <BarChart3 size={16} className="mr-1.5 text-blue-600"/> 
                        ä»»å‹™æˆæœèˆ‡ä½è­‰ (åœ–ç‰‡/æ•¸æ“š/é€£çµ)
                    </span>
                </h4>

                {/* Action Buttons to Add Evidence */}
                <div className="flex space-x-2 mb-4">
                    <button 
                        onClick={() => onAddEvidence(task.id, 'stat')}
                        className="flex-1 bg-white border border-slate-200 text-slate-600 py-1.5 px-2 rounded hover:bg-slate-50 hover:text-indigo-600 transition-colors text-xs flex items-center justify-center font-medium"
                    >
                        <Activity size={14} className="mr-1"/> + çµ±è¨ˆæ•¸æ“š
                    </button>
                    <button 
                        onClick={() => onAddEvidence(task.id, 'image')}
                        className="flex-1 bg-white border border-slate-200 text-slate-600 py-1.5 px-2 rounded hover:bg-slate-50 hover:text-indigo-600 transition-colors text-xs flex items-center justify-center font-medium"
                    >
                        <ImageIcon size={14} className="mr-1"/> + ä¸Šå‚³åœ–ç‰‡
                    </button>
                    <button 
                        onClick={() => onAddEvidence(task.id, 'link')}
                        className="flex-1 bg-white border border-slate-200 text-slate-600 py-1.5 px-2 rounded hover:bg-slate-50 hover:text-indigo-600 transition-colors text-xs flex items-center justify-center font-medium"
                    >
                        <LinkIcon size={14} className="mr-1"/> + Drive é€£çµ
                    </button>
                </div>
                
                {/* Evidence Grid Display */}
                <div className="flex flex-wrap gap-3">
                    {task.evidence && task.evidence.length > 0 ? (
                        task.evidence.map((ev) => (
                            <EvidenceDisplay 
                                key={ev.id} 
                                evidence={ev} 
                                onDelete={() => onDeleteEvidence(task.id, ev.id)}
                            />
                        ))
                    ) : (
                        <div className="w-full text-center text-xs text-slate-400 py-4 border-2 border-dashed border-slate-200 rounded-lg">
                            å°šç„¡ä½è­‰è³‡æ–™ï¼Œè«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢
                        </div>
                    )}
                </div>
            </div>

            {/* Actions */}
            <div className="flex justify-end pt-2">
                {task.status !== 'done' && (
                    <button 
                        onClick={() => onUpdateStatus(task.id, 'done')}
                        className="bg-emerald-600 text-white px-5 py-2.5 rounded-lg text-sm font-medium hover:bg-emerald-700 flex items-center shadow-md transform active:scale-95 transition-all"
                    >
                        <CheckCircle size={16} className="mr-2"/> 
                        ç¢ºèªä»»å‹™å®Œæˆ
                    </button>
                )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// ... CreateTaskForm remains similar, just hidden for brevity if not changed logic ...
// Re-using the same CreateTaskForm but assuming it's imported or defined as in previous example.
const CreateTaskForm = ({ users, onCancel, onCreate }) => {
    // ... logic same as before ...
    const [formData, setFormData] = useState({
        title: '',
        rawDescription: '',
        aiDescription: '',
        assignerId: null,
        assigneeId: null,
        collaboratorIds: [],
        roleCategory: 'medical_admin',
        dates: { plan: '', interim: '', final: '' }
    });
    
    const [isListening, setIsListening] = useState(false);
    const [isProcessingAI, setIsProcessingAI] = useState(false);

    const simulateVoiceInput = () => {
        setIsListening(true);
        setTimeout(() => {
            setIsListening(false);
            setFormData(prev => ({
                ...prev,
                rawDescription: 'è«‹å¹«æˆ‘è«‹æå°ˆå“¡å»è¦åŠƒä¸€ä¸‹é€™å€‹å­£åº¦çš„ç—…æˆ¿æ»¿æ„åº¦èª¿æŸ¥ï¼Œç„¶å¾Œè¨˜å¾—è¦è·Ÿè­·ç†é•·é‚„æœ‰ç¤¾å·¥ä¸€èµ·è¨è«–ï¼Œå¤§æ¦‚ä¸‹å€‹æœˆä¸­è¦çµ¦æˆ‘çµæœï¼Œä¸­é–“è¦å…ˆå›å ±ä¸€æ¬¡ã€‚'
            }));
        }, 1500);
    };

    const processWithAI = () => {
        if (!formData.rawDescription) return;
        setIsProcessingAI(true);
        setTimeout(() => {
            setIsProcessingAI(false);
            setFormData(prev => ({
                ...prev,
                aiDescription: `æ ¹æ“šå£è¿°å…§å®¹ç”Ÿæˆå·¥ä½œä»»å‹™ï¼š\n1. è¦åŠƒæœ¬å­£åº¦ç—…æˆ¿æ»¿æ„åº¦èª¿æŸ¥è¨ˆç•«ã€‚\n2. å¬é›†è­·ç†éƒ¨èˆ‡ç¤¾å·¥éƒ¨é€²è¡Œè·¨éƒ¨é–€å”èª¿æœƒè­°ã€‚\n3. åŸ·è¡Œèª¿æŸ¥ä¸¦å½™æ•´æ•¸æ“šå ±å‘Šã€‚\n\næ³¨æ„äº‹é …ï¼šéœ€åŒ…å«é‡åŒ–æ•¸æ“šçµ±è¨ˆèˆ‡è³ªæ€§å›é¥‹åˆ†æã€‚`
            }));
        }, 1000);
    };

    const handleSubmit = () => {
        if (!formData.title || !formData.assigneeId || !formData.dates.final) {
            alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š (æ¨™é¡Œã€æ‰¿è¾¦äººã€æœ€çµ‚æœŸé™)');
            return;
        }
        onCreate({
            ...formData,
            description: formData.aiDescription || formData.rawDescription,
            status: 'pending',
            evidence: []
        });
    };
    
    return (
        <div className="bg-white rounded-xl shadow-lg border p-6 animate-fade-in">
        <h2 className="text-xl font-bold mb-6 text-slate-800 flex items-center">
            <Plus className="mr-2" /> æ–°å¢äº¤è¾¦ä»»å‹™
        </h2>

        {/* Roles Selection */}
        <UserSelector 
            label="1. èª°äº¤è¾¦ï¼Ÿ (äº¤è¾¦äºº)" 
            users={users} 
            selectedId={formData.assignerId}
            onSelect={(id) => setFormData({...formData, assignerId: id})}
        />
        
        <UserSelector 
            label="2. äº¤çµ¦èª°ï¼Ÿ (æ‰¿è¾¦äºº)" 
            users={users} 
            selectedId={formData.assigneeId}
            onSelect={(id) => setFormData({...formData, assigneeId: id})}
        />

        <UserSelector 
            label="3. èª°å”åŠ©ï¼Ÿ (å”ä½œè€…)" 
            users={users} 
            selectedIds={formData.collaboratorIds}
            onSelect={(ids) => setFormData({...formData, collaboratorIds: ids})}
            multiple={true}
        />

        <div className="mb-6">
            <label className="block text-sm font-medium text-slate-700 mb-2">è·é¡æ­¸å±¬</label>
            <div className="flex flex-wrap gap-2">
                {ROLES.map(role => (
                    <button
                        key={role.id}
                        onClick={() => setFormData({...formData, roleCategory: role.id})}
                        className={`px-3 py-1 text-sm rounded-full transition-colors ${
                            formData.roleCategory === role.id 
                            ? 'bg-slate-800 text-white' 
                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                        }`}
                    >
                        {role.name}
                    </button>
                ))}
            </div>
        </div>

        {/* AI Voice Input */}
        <div className="mb-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
            <label className="block text-sm font-bold text-slate-700 mb-2">4. ä»»å‹™æè¿° (AI èªéŸ³è¼”åŠ©)</label>
            <div className="relative mb-3">
                <textarea 
                    className="w-full p-3 pr-12 border rounded-lg focus:ring-2 focus:ring-indigo-500 h-24"
                    placeholder="é»æ“Šéº¥å…‹é¢¨é–‹å§‹å£è¿°ä»»å‹™..."
                    value={formData.rawDescription}
                    onChange={(e) => setFormData({...formData, rawDescription: e.target.value})}
                />
                <button 
                    onClick={simulateVoiceInput}
                    className={`absolute right-3 top-3 p-2 rounded-full ${isListening ? 'bg-red-500 animate-pulse text-white' : 'bg-slate-200 text-slate-600 hover:bg-slate-300'}`}
                >
                    <Mic size={20} />
                </button>
            </div>
            
            <button 
                onClick={processWithAI}
                disabled={!formData.rawDescription || isProcessingAI}
                className="w-full bg-indigo-600 text-white py-2 rounded-lg flex items-center justify-center hover:bg-indigo-700 disabled:opacity-50"
            >
                {isProcessingAI ? 'AI åˆ†æä¸­...' : <><Bot className="mr-2" size={18}/> ä¸²æ¥ AI å½¢æˆçµæ§‹åŒ–å·¥ä½œä»»å‹™</>}
            </button>

            {formData.aiDescription && (
                <div className="mt-3 bg-white p-3 rounded border border-indigo-100">
                    <div className="text-xs text-indigo-500 font-bold mb-1">AI ç”¢å‡ºçµæœï¼š</div>
                    <textarea 
                        className="w-full text-sm text-slate-700 border-none focus:ring-0 p-0 resize-none h-24"
                        value={formData.aiDescription}
                        onChange={(e) => setFormData({...formData, aiDescription: e.target.value})}
                    />
                </div>
            )}
        </div>

        {/* Basic Info */}
        <div className="mb-6">
            <label className="block text-sm font-medium text-slate-700 mb-2">ä»»å‹™æ¨™é¡Œ</label>
            <input 
                type="text" 
                className="w-full p-2 border rounded-lg"
                value={formData.title}
                onChange={(e) => setFormData({...formData, title: e.target.value})}
                placeholder="ä¾‹å¦‚ï¼šQ3 è·å®‰å›å ±"
            />
        </div>

        {/* Dates */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">è¨ˆç•«åŸ·è¡Œè¦åŠƒæ—¥æœŸ</label>
                <input 
                    type="date" 
                    className="w-full p-2 border rounded"
                    value={formData.dates.plan}
                    onChange={(e) => setFormData({...formData, dates: { ...formData.dates, plan: e.target.value }})}
                />
            </div>
            <div>
                <label className="block text-xs font-bold text-orange-600 mb-1">æœŸä¸­å›å ±æ—¥æœŸ</label>
                <input 
                    type="date" 
                    className="w-full p-2 border rounded border-orange-200"
                    value={formData.dates.interim}
                    onChange={(e) => setFormData({...formData, dates: { ...formData.dates, interim: e.target.value }})}
                />
            </div>
            <div>
                <label className="block text-xs font-bold text-red-600 mb-1">æœ€çµ‚çµæœå›å ±æ—¥æœŸ</label>
                <input 
                    type="date" 
                    className="w-full p-2 border rounded border-red-200"
                    value={formData.dates.final}
                    onChange={(e) => setFormData({...formData, dates: { ...formData.dates, final: e.target.value }})}
                />
            </div>
        </div>

        <div className="flex space-x-3">
            <button onClick={onCancel} className="flex-1 py-3 bg-slate-100 text-slate-600 rounded-lg font-medium hover:bg-slate-200">
                å–æ¶ˆ
            </button>
            <button onClick={handleSubmit} className="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-lg">
                ç¢ºèªäº¤è¾¦
            </button>
        </div>
    </div>
    );
};

// --- Main Application ---

export default function App() {
  const [view, setView] = useState('dashboard');
  const [tasks, setTasks] = useState(INITIAL_TASKS);
  const [selectedRole, setSelectedRole] = useState('all');
  const [stats, setStats] = useState({ total: 0, done: 0, overdue: 0 });

  useEffect(() => {
    const roleTasks = selectedRole === 'all' 
        ? tasks 
        : tasks.filter(t => t.roleCategory === selectedRole);
    
    const today = new Date().toISOString().split('T')[0];
    const done = roleTasks.filter(t => t.status === 'done').length;
    const overdue = roleTasks.filter(t => t.status !== 'done' && t.dates.final < today).length;
    
    setStats({
        total: roleTasks.length,
        done,
        overdue
    });
  }, [tasks, selectedRole]);

  const handleCreateTask = (newTaskData) => {
    const newTask = {
        id: Date.now(),
        ...newTaskData
    };
    setTasks([newTask, ...tasks]);
    setView('dashboard');
  };

  const handleUpdateStatus = (taskId, status) => {
    setTasks(tasks.map(t => t.id === taskId ? { ...t, status } : t));
  };

  const handleUpdateResponse = (taskId, response) => {
    setTasks(tasks.map(t => t.id === taskId ? { ...t, assigneeResponse: response, status: 'in_progress' } : t));
  };

  const handleDeleteEvidence = (taskId, evidenceId) => {
    setTasks(tasks.map(t => {
        if (t.id === taskId) {
            return { ...t, evidence: t.evidence.filter(e => e.id !== evidenceId) };
        }
        return t;
    }));
  };

  const handleAddEvidence = (taskId, type) => {
    let newEvidence = null;
    const id = Date.now().toString();

    if (type === 'stat') {
        const val = prompt('è«‹è¼¸å…¥çµ±è¨ˆæ•¸å€¼ (ä¾‹å¦‚: 85%)', '90%');
        const label = prompt('è«‹è¼¸å…¥æ•¸å€¼æ¨™ç±¤ (ä¾‹å¦‚: å®Œæˆç‡)', 'é”æˆç‡');
        if (val && label) {
            newEvidence = { id, type: 'stat', label, value: val };
        }
    } else if (type === 'link') {
        const url = prompt('è«‹è¼¸å…¥ Google Drive é€£çµ', 'https://drive.google.com/...');
        const name = prompt('è«‹è¼¸å…¥è³‡æ–™å¤¾åç¨±', 'å°ˆæ¡ˆä½è­‰è³‡æ–™å¤¾');
        if (url && name) {
            newEvidence = { id, type: 'link', name, url };
        }
    } else if (type === 'image') {
        // Simulating upload
        newEvidence = { 
            id, 
            type: 'image', 
            name: 'ä¸Šå‚³åœ–ç‰‡.jpg', 
            url: 'https://via.placeholder.com/300x200?text=Uploaded+Image' 
        };
        alert('å·²æ¨¡æ“¬åœ–ç‰‡ä¸Šå‚³');
    }

    if (newEvidence) {
        setTasks(tasks.map(t => t.id === taskId ? { ...t, evidence: [...t.evidence, newEvidence] } : t));
    }
  };

  const filteredTasks = useMemo(() => {
    if (selectedRole === 'all') return tasks;
    return tasks.filter(t => t.roleCategory === selectedRole);
  }, [tasks, selectedRole]);

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-900 pb-20">
      
      {/* Top Header */}
      <header className="bg-gradient-to-r from-indigo-700 to-indigo-600 text-white sticky top-0 z-20 shadow-lg">
        <div className="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <h1 className="text-xl font-bold flex items-center">
                    <Activity className="mr-2" /> 
                    ä»»å‹™äº¤è¾¦æš¨çµ±è¨ˆå„€è¡¨æ¿
                </h1>
                <p className="text-xs text-indigo-200 mt-1">æ™ºæ…§åŒ–æˆæœç®¡ç†ç³»çµ±</p>
            </div>
            <button 
                onClick={() => setView(view === 'dashboard' ? 'create' : 'dashboard')}
                className="bg-white text-indigo-700 px-4 py-2 rounded-full font-bold shadow-md hover:bg-indigo-50 transition-colors flex items-center transform hover:scale-105 active:scale-95"
            >
                {view === 'dashboard' ? <><Plus size={18} className="mr-1"/> äº¤è¾¦ä»»å‹™</> : 'è¿”å›ç¸½è¡¨'}
            </button>
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-4 py-6">
        
        {view === 'create' ? (
            <CreateTaskForm 
                users={USERS} 
                onCancel={() => setView('dashboard')}
                onCreate={handleCreateTask}
            />
        ) : (
            <div className="animate-fade-in">
                
                {/* Stats Dashboard */}
                <div className="grid grid-cols-3 gap-4 mb-6">
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col items-center justify-center">
                        <div className="text-3xl font-bold text-slate-700">{stats.total}</div>
                        <div className="text-xs text-slate-500 uppercase tracking-wide">ç¸½ä»»å‹™æ•¸</div>
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col items-center justify-center">
                        <div className="text-3xl font-bold text-emerald-600">{Math.round((stats.done / stats.total || 0) * 100)}%</div>
                        <div className="text-xs text-slate-500 uppercase tracking-wide">å®Œæˆç‡</div>
                    </div>
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col items-center justify-center relative overflow-hidden">
                        {stats.overdue > 0 && <div className="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full animate-ping m-2"></div>}
                        <div className={`text-3xl font-bold ${stats.overdue > 0 ? 'text-red-600' : 'text-slate-700'}`}>{stats.overdue}</div>
                        <div className="text-xs text-slate-500 uppercase tracking-wide">é€¾æœŸ/è­¦ç¤º</div>
                    </div>
                </div>

                {/* Role Filter Tabs */}
                <div className="flex overflow-x-auto space-x-2 mb-6 pb-2 no-scrollbar">
                    <button 
                        onClick={() => setSelectedRole('all')}
                        className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all ${selectedRole === 'all' ? 'bg-slate-800 text-white' : 'bg-white text-slate-600 shadow-sm'}`}
                    >
                        ç¸½è¦½
                    </button>
                    {ROLES.map(role => (
                        <button
                            key={role.id}
                            onClick={() => setSelectedRole(role.id)}
                            className={`flex-shrink-0 flex items-center px-4 py-2 rounded-full text-sm font-medium transition-all ${
                                selectedRole === role.id 
                                ? role.color.replace('bg-', 'bg-').replace('text-', 'text-white bg-opacity-100 bg-') 
                                : 'bg-white text-slate-600 shadow-sm'
                            } ${selectedRole === role.id ? 'ring-2 ring-offset-1 ring-slate-300' : ''}`}
                            style={selectedRole === role.id ? { backgroundColor: 'var(--tw-bg-opacity)' } : {}}
                        >
                            <role.icon size={14} className="mr-2"/>
                            {role.name}
                        </button>
                    ))}
                </div>

                {/* Task List */}
                <div className="space-y-4">
                    {filteredTasks.length === 0 ? (
                        <div className="text-center py-12 text-slate-400">
                            <FileText size={48} className="mx-auto mb-2 opacity-50"/>
                            <p>ç›®å‰è©²åˆ†é¡æ²’æœ‰ä»»å‹™</p>
                        </div>
                    ) : (
                        filteredTasks.map(task => (
                            <TaskCard 
                                key={task.id} 
                                task={task} 
                                users={USERS}
                                onUpdateStatus={handleUpdateStatus}
                                onUpdateResponse={handleUpdateResponse}
                                onAddEvidence={handleAddEvidence}
                                onDeleteEvidence={handleDeleteEvidence}
                            />
                        ))
                    )}
                </div>
            </div>
        )}
      </main>
    </div>
  );
}