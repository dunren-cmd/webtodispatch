# åŸ·è¡Œ SQL è¤‡è£½è³‡æ–™çš„èªªæ˜

## ğŸš€ å¿«é€ŸåŸ·è¡Œæ­¥é©Ÿ

### æ–¹æ³•ä¸€ï¼šä¸€æ¬¡æ€§åŸ·è¡Œï¼ˆæ¨è–¦ï¼‰

1. **æ‰“é–‹ Supabase Dashboard**
   - ç™»å…¥ Supabase
   - é¸æ“‡ä½ çš„å°ˆæ¡ˆ
   - é»æ“Šå·¦å´é¸å–®çš„ **SQL Editor**

2. **è¤‡è£½ SQL è…³æœ¬**
   - æ‰“é–‹ `ç›´æ¥åŸ·è¡Œ_è¤‡è£½è³‡æ–™.sql` æª”æ¡ˆ
   - è¤‡è£½å…¨éƒ¨å…§å®¹ï¼ˆCtrl+A, Ctrl+Cï¼‰

3. **è²¼ä¸Šä¸¦åŸ·è¡Œ**
   - åœ¨ SQL Editor ä¸­è²¼ä¸Šï¼ˆCtrl+Vï¼‰
   - é»æ“Š **Run** æˆ–æŒ‰ **Ctrl+Enter**

4. **æŸ¥çœ‹çµæœ**
   - åŸ·è¡Œå¾Œæœƒé¡¯ç¤ºï¼š
     - PersonnelData çš„è³‡æ–™åˆ—è¡¨
     - è¤‡è£½å¾Œçš„ users è³‡æ–™
     - å°æ¯”çµæœï¼ˆç¢ºèªæ˜¯å¦æˆåŠŸï¼‰

---

### æ–¹æ³•äºŒï¼šåˆ†æ®µåŸ·è¡Œï¼ˆå¦‚æœä¸€æ¬¡æ€§åŸ·è¡Œå¤±æ•—ï¼‰

#### æ­¥é©Ÿ 1ï¼šæ·»åŠ æ¬„ä½ï¼ˆå…ˆåŸ·è¡Œé€™å€‹ï¼‰

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS mail TEXT;
ALTER TABLE users ADD COLUMN IF NOT EXISTS headshot TEXT;
```

#### æ­¥é©Ÿ 2ï¼šæŸ¥çœ‹ PersonnelData çš„è³‡æ–™

```sql
SELECT 
  id,
  name,
  "JobTitle",
  "Mail",
  drive_link
FROM "PersonnelData"
ORDER BY id;
```

#### æ­¥é©Ÿ 3ï¼šåŸ·è¡Œè¤‡è£½ï¼ˆç¢ºèªè³‡æ–™ç„¡èª¤å¾ŒåŸ·è¡Œï¼‰

```sql
INSERT INTO users (id, name, role, mail, headshot, timestamp)
SELECT 
  p.id,
  p.name,
  p."JobTitle" as role,
  p."Mail" as mail,
  p.drive_link as headshot,
  COALESCE(p.timestamp, NOW()) as timestamp
FROM "PersonnelData" p
ON CONFLICT (id) 
DO UPDATE SET
  name = EXCLUDED.name,
  role = EXCLUDED.role,
  mail = EXCLUDED.mail,
  headshot = EXCLUDED.headshot;
```

#### æ­¥é©Ÿ 4ï¼šé©—è­‰çµæœ

```sql
SELECT 
  p.id,
  p.name as personnel_name,
  p."JobTitle" as personnel_role,
  u.name as user_name,
  u.role as user_role,
  u.mail,
  u.headshot
FROM "PersonnelData" p
LEFT JOIN users u ON p.id = u.id
ORDER BY p.id;
```

---

## âš ï¸ æ³¨æ„äº‹é …

1. **å‚™ä»½è³‡æ–™**ï¼ˆå»ºè­°å…ˆåŸ·è¡Œï¼‰ï¼š
   ```sql
   CREATE TABLE users_backup AS SELECT * FROM users;
   ```

2. **å¦‚æœåŸ·è¡Œå¤±æ•—**ï¼š
   - æª¢æŸ¥éŒ¯èª¤è¨Šæ¯
   - ç¢ºèª PersonnelData è¡¨å­˜åœ¨
   - ç¢ºèªæ¬„ä½åç¨±æ­£ç¢ºï¼ˆ`Mail` æ˜¯å¤§å¯« Mï¼Œ`JobTitle` æ˜¯å¤§å°å¯«æ··åˆï¼‰

3. **å¦‚æœ users è¡¨ä¸­å·²æœ‰è³‡æ–™**ï¼š
   - é€™å€‹ SQL æœƒè‡ªå‹•æ›´æ–°ç¾æœ‰è¨˜éŒ„ï¼ˆæ ¹æ“š id åŒ¹é…ï¼‰
   - ä¸æœƒåˆªé™¤ users è¡¨ä¸­å…¶ä»–ä¸å­˜åœ¨çš„è¨˜éŒ„

---

## âœ… æˆåŠŸæ¨™èªŒ

åŸ·è¡Œé©—è­‰ SQL å¾Œï¼Œå¦‚æœçœ‹åˆ°ï¼š
- `status` æ¬„ä½é¡¯ç¤º `âœ… æˆåŠŸ`
- `copied_to_users` æ•¸é‡ç­‰æ–¼ `total_personnel`

è¡¨ç¤ºè¤‡è£½æˆåŠŸï¼

---

## ğŸ”§ å¦‚æœé‡åˆ°éŒ¯èª¤

### éŒ¯èª¤ 1ï¼š`column "mail" does not exist`
**è§£æ±ºæ–¹æ³•**ï¼šå…ˆåŸ·è¡Œæ­¥é©Ÿ 1 æ·»åŠ æ¬„ä½

### éŒ¯èª¤ 2ï¼š`column p."Mail" does not exist`
**è§£æ±ºæ–¹æ³•**ï¼šæª¢æŸ¥ PersonnelData è¡¨çš„å¯¦éš›æ¬„ä½åç¨±
```sql
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'PersonnelData';
```

### éŒ¯èª¤ 3ï¼š`duplicate key value violates unique constraint`
**è§£æ±ºæ–¹æ³•**ï¼šé€™æ˜¯æ­£å¸¸çš„ï¼Œè¡¨ç¤º id å·²å­˜åœ¨ï¼Œæœƒè‡ªå‹•æ›´æ–°

---

## ğŸ“ éœ€è¦å”åŠ©ï¼Ÿ

å¦‚æœåŸ·è¡Œå¾Œä»æœ‰å•é¡Œï¼Œè«‹æä¾›ï¼š
1. å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯
2. PersonnelData è¡¨çš„æ¬„ä½åˆ—è¡¨ï¼ˆåŸ·è¡Œæ­¥é©Ÿ 2 çš„æŸ¥è©¢çµæœï¼‰
