// ========================================
// Email é€šçŸ¥åŠŸèƒ½ç¯„ä¾‹ä»£ç¢¼
// å°‡é€™äº›å‡½æ•¸æ·»åŠ åˆ° Code.gs ä¸­
// ========================================

/**
 * ç™¼é€ä»»å‹™æŒ‡æ´¾é€šçŸ¥
 */
function sendTaskAssignmentEmail(assigneeEmail, assigneeName, taskTitle, taskDescription, assignerName, taskUrl) {
  try {
    const subject = `ğŸ“‹ æ–°ä»»å‹™æŒ‡æ´¾ï¼š${taskTitle}`;
    const htmlBody = `
      <html>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
          <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
            <h2 style="color: #4f46e5;">ğŸ“‹ æ‚¨æœ‰æ–°çš„ä»»å‹™æŒ‡æ´¾</h2>
            <p>è¦ªæ„›çš„ <strong>${assigneeName}</strong>ï¼Œ</p>
            <p><strong>${assignerName}</strong> æŒ‡æ´¾äº†ä¸€å€‹æ–°ä»»å‹™çµ¦æ‚¨ï¼š</p>
            
            <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0;">
              <h3 style="margin-top: 0; color: #1f2937;">${taskTitle}</h3>
              <p style="margin-bottom: 0;">${taskDescription || 'ç„¡è©³ç´°èªªæ˜'}</p>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
              <a href="${taskUrl}" 
                 style="background-color: #4f46e5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
                æŸ¥çœ‹ä»»å‹™è©³æƒ…
              </a>
            </div>
            
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #6b7280; font-size: 12px;">
              é€™æ˜¯ç³»çµ±è‡ªå‹•ç™¼é€çš„é€šçŸ¥éƒµä»¶ï¼Œè«‹å‹¿ç›´æ¥å›è¦†ã€‚<br>
              å¦‚æœ‰å•é¡Œï¼Œè«‹ç™»å…¥ç³»çµ±æŸ¥çœ‹ä»»å‹™è©³æƒ…ã€‚
            </p>
          </div>
        </body>
      </html>
    `;
    
    MailApp.sendEmail({
      to: assigneeEmail,
      subject: subject,
      htmlBody: htmlBody
    });
    
    Logger.log(`âœ… ä»»å‹™æŒ‡æ´¾é€šçŸ¥å·²ç™¼é€åˆ°ï¼š${assigneeEmail}`);
    return { success: true };
  } catch (error) {
    Logger.log(`âŒ ç™¼é€ email å¤±æ•—ï¼š${error.toString()}`);
    return { success: false, error: error.toString() };
  }
}

/**
 * ç™¼é€èŠå¤©è¨Šæ¯é€šçŸ¥
 */
function sendChatNotificationEmail(recipientEmail, recipientName, senderName, message, taskTitle, chatUrl) {
  try {
    const subject = `ğŸ’¬ ä¾†è‡ª ${senderName} çš„æ–°è¨Šæ¯`;
    const htmlBody = `
      <html>
        <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
          <div style="max-width: 600px; margin: 0 auto; padding: 20px;">
            <h2 style="color: #4f46e5;">ğŸ’¬ æ‚¨æœ‰æ–°çš„è¨Šæ¯</h2>
            <p>è¦ªæ„›çš„ <strong>${recipientName}</strong>ï¼Œ</p>
            <p><strong>${senderName}</strong> åœ¨ä»»å‹™ <strong>${taskTitle}</strong> ä¸­ç™¼é€äº†ä¸€å‰‡è¨Šæ¯ï¼š</p>
            
            <div style="background-color: #f3f4f6; padding: 15px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #4f46e5;">
              <p style="margin: 0;">${message}</p>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
              <a href="${chatUrl}" 
                 style="background-color: #4f46e5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">
                æŸ¥çœ‹å®Œæ•´å°è©±
              </a>
            </div>
            
            <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
            <p style="color: #6b7280; font-size: 12px;">
              é€™æ˜¯ç³»çµ±è‡ªå‹•ç™¼é€çš„é€šçŸ¥éƒµä»¶ï¼Œè«‹å‹¿ç›´æ¥å›è¦†ã€‚
            </p>
          </div>
        </body>
      </html>
    `;
    
    MailApp.sendEmail({
      to: recipientEmail,
      subject: subject,
      htmlBody: htmlBody
    });
    
    Logger.log(`âœ… èŠå¤©é€šçŸ¥å·²ç™¼é€åˆ°ï¼š${recipientEmail}`);
    return { success: true };
  } catch (error) {
    Logger.log(`âŒ ç™¼é€ email å¤±æ•—ï¼š${error.toString()}`);
    return { success: false, error: error.toString() };
  }
}

/**
 * å¾ users æˆ– personnel è¡¨å–å¾—ç”¨æˆ¶ email
 */
function getUserEmail(userId) {
  try {
    // æ–¹æ³• 1ï¼šå¾ users è¡¨å–å¾—ï¼ˆå¦‚æœ users è¡¨æœ‰ email æ¬„ä½ï¼‰
    const filter = `id=eq.${userId}`;
    const result = supabaseRequest('GET', SUPABASE_TABLE_USERS, null, filter);
    
    if (result && result.length > 0 && result[0].email) {
      return result[0].email;
    }
    
    // æ–¹æ³• 2ï¼šå¾ personnel è¡¨å–å¾—ï¼ˆé€šé employee_id é—œè¯ï¼‰
    // é€™è£¡éœ€è¦æ ¹æ“šå¯¦éš›çš„é—œè¯é‚è¼¯èª¿æ•´
    // const employeeId = result[0].employee_id;
    // const personnelResult = supabaseRequest('GET', 'personnel', null, `employee_id=eq.${employeeId}`);
    // if (personnelResult && personnelResult.length > 0) {
    //   return personnelResult[0].email;
    // }
    
    return null;
  } catch (error) {
    Logger.log(`âŒ å–å¾—ç”¨æˆ¶ email å¤±æ•—ï¼š${error.toString()}`);
    return null;
  }
}

/**
 * æ¸¬è©¦ç™¼é€ Emailï¼ˆè«‹å°‡ test@example.com æ›¿æ›ç‚ºæ‚¨çš„ emailï¼‰
 */
function testSendEmail() {
  sendTaskAssignmentEmail(
    'test@example.com',  // æ›¿æ›ç‚ºæ‚¨çš„ email
    'æ¸¬è©¦ç”¨æˆ¶',
    'æ¸¬è©¦ä»»å‹™æ¨™é¡Œ',
    'é€™æ˜¯ä¸€å€‹æ¸¬è©¦ä»»å‹™æè¿°',
    'äº¤è¾¦äººå§“å',
    'http://192.168.62.101:3050'
  );
}
