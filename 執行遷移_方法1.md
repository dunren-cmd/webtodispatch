# åŸ·è¡Œè³‡æ–™åº«é·ç§» - æ–¹æ³• 1

## ğŸ“‹ æ–¹æ³• 1ï¼šä½¿ç”¨ Supabase Studioï¼ˆæ¨è–¦ï¼‰

### æ­¥é©Ÿ 1ï¼šæ‰“é–‹ Supabase Studio

åœ¨ç€è¦½å™¨ä¸­è¨ªå•ï¼š
```
http://192.168.62.101:54323
```

### æ­¥é©Ÿ 2ï¼šé€²å…¥ SQL Editor

1. é»æ“Šå·¦å´é¸å–®çš„ **SQL Editor**
2. é»æ“Š **New Query**

### æ­¥é©Ÿ 3ï¼šåŸ·è¡Œé·ç§»æ–‡ä»¶

**é¸é … Aï¼šåŸ·è¡Œå–®ä¸€é·ç§»æ–‡ä»¶ï¼ˆç§»é™¤ personnel è¡¨ï¼‰**

è¤‡è£½ä»¥ä¸‹ SQL ä¸¦åŸ·è¡Œï¼š

```sql
-- ========================================
-- ç§»é™¤ personnel è¡¨åŠå…¶ç›¸é—œä¾è³´
-- personnel è¡¨å·²å»¢æ£„ï¼Œè³‡æ–™å·²åˆä½µåˆ° users è¡¨
-- ========================================

-- ========================================
-- æ­¥é©Ÿ 1ï¼šåˆªé™¤ä¾è³´ personnel è¡¨çš„è¦–åœ–
-- ========================================

-- åˆªé™¤ user_with_personnel è¦–åœ–ï¼ˆä¾è³´ personnel è¡¨ï¼‰
DROP VIEW IF EXISTS user_with_personnel;

-- ========================================
-- æ­¥é©Ÿ 2ï¼šåˆªé™¤ä¾è³´ personnel è¡¨çš„å‡½æ•¸
-- ========================================

-- åˆªé™¤ get_user_email å‡½æ•¸ï¼ˆä¾è³´ personnel è¡¨ï¼‰
DROP FUNCTION IF EXISTS get_user_email(BIGINT);

-- ========================================
-- æ­¥é©Ÿ 3ï¼šåˆªé™¤ personnel è¡¨
-- ========================================

-- åˆªé™¤ personnel è¡¨
-- æ³¨æ„ï¼šæ­¤æ“ä½œæœƒæ°¸ä¹…åˆªé™¤è¡¨ä¸­çš„æ‰€æœ‰è³‡æ–™
-- å¦‚æœè³‡æ–™å·²åˆä½µåˆ° users è¡¨ï¼Œå¯ä»¥å®‰å…¨åˆªé™¤
DROP TABLE IF EXISTS personnel CASCADE;

-- ========================================
-- æ­¥é©Ÿ 4ï¼šé©—è­‰ç§»é™¤çµæœ
-- ========================================

-- æª¢æŸ¥è¡¨æ˜¯å¦å·²åˆªé™¤
DO $$
BEGIN
  IF EXISTS (
    SELECT 1 FROM information_schema.tables 
    WHERE table_schema = 'public' 
    AND table_name = 'personnel'
  ) THEN
    RAISE NOTICE 'è­¦å‘Šï¼špersonnel è¡¨ä»ç„¶å­˜åœ¨';
  ELSE
    RAISE NOTICE 'âœ… personnel è¡¨å·²æˆåŠŸç§»é™¤';
  END IF;
  
  IF EXISTS (
    SELECT 1 FROM information_schema.views 
    WHERE table_schema = 'public' 
    AND table_name = 'user_with_personnel'
  ) THEN
    RAISE NOTICE 'è­¦å‘Šï¼šuser_with_personnel è¦–åœ–ä»ç„¶å­˜åœ¨';
  ELSE
    RAISE NOTICE 'âœ… user_with_personnel è¦–åœ–å·²æˆåŠŸç§»é™¤';
  END IF;
  
  IF EXISTS (
    SELECT 1 FROM pg_proc p
    JOIN pg_namespace n ON p.pronamespace = n.oid
    WHERE n.nspname = 'public' 
    AND p.proname = 'get_user_email'
  ) THEN
    RAISE NOTICE 'è­¦å‘Šï¼šget_user_email å‡½æ•¸ä»ç„¶å­˜åœ¨';
  ELSE
    RAISE NOTICE 'âœ… get_user_email å‡½æ•¸å·²æˆåŠŸç§»é™¤';
  END IF;
END $$;
```

**é¸é … Bï¼šåŸ·è¡Œæ‰€æœ‰é·ç§»æ–‡ä»¶ï¼ˆé‡ç½®è³‡æ–™åº«ï¼‰**

å¦‚æœéœ€è¦é‡ç½®æ•´å€‹è³‡æ–™åº«ä¸¦åŸ·è¡Œæ‰€æœ‰é·ç§»ï¼Œè«‹æŒ‰é †åºåŸ·è¡Œä»¥ä¸‹æ–‡ä»¶ï¼š

1. `20251212134638_init.sql`
2. `20251212150000_create_personnel.sql`ï¼ˆå°‡è¢«ç§»é™¤ï¼‰
3. `20251212155000_fill_personneldata_id.sql`
4. `20251212160000_link_users_personnel.sql`
5. `20251212170000_merge_personnel_to_users.sql`
6. `20251213000000_change_avatar_to_level.sql`
7. `20251213120000_update_level5_to_level4.sql`
8. `20251214000000_fix_users_table_structure.sql`
9. `20251215000000_create_roles_table.sql`
10. `20251218170000_remove_personnel_table.sql`ï¼ˆæ–°å¢ï¼‰

### æ­¥é©Ÿ 4ï¼šé©—è­‰çµæœ

åŸ·è¡Œä»¥ä¸‹æŸ¥è©¢ç¢ºèªï¼š

```sql
-- æª¢æŸ¥ personnel è¡¨æ˜¯å¦å·²åˆªé™¤
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name = 'personnel';

-- æ‡‰è©²è¿”å› 0 è¡Œ

-- æª¢æŸ¥è¦–åœ–æ˜¯å¦å·²åˆªé™¤
SELECT table_name 
FROM information_schema.views 
WHERE table_schema = 'public' 
AND table_name = 'user_with_personnel';

-- æ‡‰è©²è¿”å› 0 è¡Œ

-- æª¢æŸ¥å‡½æ•¸æ˜¯å¦å·²åˆªé™¤
SELECT proname 
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public' 
AND p.proname = 'get_user_email';

-- æ‡‰è©²è¿”å› 0 è¡Œ
```

---

## ğŸ“‹ æ–¹æ³• 2ï¼šä½¿ç”¨ Supabase CLIï¼ˆå¦‚æœå·²å®‰è£ï¼‰

å¦‚æœå·²å®‰è£ Supabase CLIï¼Œå¯ä»¥åŸ·è¡Œï¼š

```bash
# é‡ç½®è³‡æ–™åº«ä¸¦åŸ·è¡Œæ‰€æœ‰é·ç§»
supabase db reset

# æˆ–åªåŸ·è¡Œæ–°é·ç§»
supabase migration up
```

---

## âš ï¸ æ³¨æ„äº‹é …

1. **è³‡æ–™å‚™ä»½**ï¼šåŸ·è¡Œ `DROP TABLE` æœƒæ°¸ä¹…åˆªé™¤è³‡æ–™ï¼Œè«‹ç¢ºä¿è³‡æ–™å·²å‚™ä»½æˆ–å·²åˆä½µåˆ°å…¶ä»–è¡¨
2. **ä¾è³´é—œä¿‚**ï¼š`DROP TABLE ... CASCADE` æœƒè‡ªå‹•åˆªé™¤ç›¸é—œçš„è¦–åœ–å’Œå‡½æ•¸
3. **åŸ·è¡Œé †åº**ï¼šå¦‚æœåŸ·è¡Œæ‰€æœ‰é·ç§»ï¼Œè«‹æŒ‰ç…§æ™‚é–“æˆ³é †åºåŸ·è¡Œ

---

## âœ… åŸ·è¡Œå®Œæˆå¾Œ

åŸ·è¡Œå®Œæˆå¾Œï¼Œè«‹ï¼š

1. **é‡æ–°åŒ¯å…¥è³‡æ–™**ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š
   ```bash
   python3 import_all_csv_to_supabase.py \
     --roles "roles_rows.csv" \
     --users "users_rows (2).csv" \
     --tasks "tasks_rows.csv"
   ```

2. **é‡æ–°æ•´ç†ç€è¦½å™¨é é¢**ä»¥æŸ¥çœ‹æ›´æ–°
