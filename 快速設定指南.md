# 快速設定指南 - 串接 Google Sheets

## 🎯 目標
將前端 React 應用程式串接到 Google Sheets 作為後端資料庫。

---

## 📝 步驟 1：建立 Google Sheets 試算表

### 1.1 建立新試算表
1. 前往 [Google Sheets](https://sheets.google.com/)
2. 建立新的試算表
3. 重新命名為「任務交辦系統」（或你喜歡的名稱）

### 1.2 取得試算表 ID
1. 查看網址列，例如：
   ```
   https://docs.google.com/spreadsheets/d/1Y_DdF0sGFjSqCi9SPelZlkF6Mz32q5O0XNjdPOaq-c8/edit
   ```
2. **複製中間的 ID**：`1Y_DdF0sGFjSqCi9SPelZlkF6Mz32q5O0XNjdPOaq-c8`
3. 這個 ID 稍後會用到

### 1.3 建立工作表（可選，程式會自動建立）
系統會自動建立「交辦紀錄」工作表，但如果你想手動建立：

1. 在工作表底部點擊「+」新增工作表
2. 重新命名為「交辦紀錄」
3. 在第一列設定標題（程式會自動覆蓋，但可以先設定）：
   - A欄：時間戳記
   - B欄：任務ID
   - C欄：任務標題
   - D欄：任務描述
   - E欄：交辦人ID
   - F欄：交辦人姓名
   - G欄：承辦人ID
   - H欄：承辦人姓名
   - I欄：協作者IDs
   - J欄：職類歸屬
   - K欄：計畫日期
   - L欄：期中日期
   - M欄：最終日期
   - N欄：狀態
   - O欄：承辦人回覆
   - P欄：佐證資料

---

## 📝 步驟 2：建立 Google Apps Script 專案

### 2.1 建立新專案
1. 前往 [Google Apps Script](https://script.google.com/)
2. 點擊「新增專案」
3. 重新命名專案為「任務交辦系統後端」

### 2.2 貼上程式碼
1. 刪除預設的 `myFunction` 程式碼
2. 開啟本資料夾中的 `Code.gs` 檔案
3. **複製全部內容**並貼到 Apps Script 編輯器

### 2.3 設定試算表 ID
1. 在 `Code.gs` 中找到這一行：
   ```javascript
   const SPREADSHEET_ID = "請替換為你的試算表ID";
   ```
2. 將 `"請替換為你的試算表ID"` 替換為你在步驟 1.2 取得的試算表 ID
3. 例如：
   ```javascript
   const SPREADSHEET_ID = "1Y_DdF0sGFjSqCi9SPelZlkF6Mz32q5O0XNjdPOaq-c8";
   ```

### 2.4 儲存專案
1. 點擊左上角的「儲存」圖示（💾）
2. 或按 `Ctrl+S`（Windows）或 `Cmd+S`（Mac）

---

## 📝 步驟 3：部署為 Web App

### 3.1 開始部署
1. 在 Apps Script 編輯器中，點擊右上角的「部署」
2. 選擇「新增部署作業」

### 3.2 設定部署選項
1. **選擇類型**：點擊「選取類型」→ 選擇「網頁應用程式」
2. **設定說明**：
   - **說明**：可以輸入「任務交辦系統 API v1」（可選）
   - **執行身分**：選擇「我」
   - **具有存取權的使用者**：**選擇「任何人」** ⚠️ 這很重要！
3. 點擊「部署」

### 3.3 授權應用程式
1. 首次部署會要求授權
2. 點擊「授權存取權限」
3. 選擇你的 Google 帳號
4. 點擊「進階」→「前往 [專案名稱]（不安全）」
5. 點擊「允許」

### 3.4 取得 Web App URL
1. 部署成功後，會顯示「網頁應用程式網址」
2. **複製這個 URL**，例如：
   ```
   https://script.google.com/macros/s/AKfycbyyfLr8CnSroku2PCXJfO_e8sUoy8Dh6CjCQ88L-_b71Phi69p9v4naV1Xi30qISQw8/exec
   ```
3. 這個 URL 稍後會用到

---

## 📝 步驟 4：設定前端 API

### 4.1 開啟 api.ts 檔案
1. 開啟本資料夾中的 `api.ts` 檔案

### 4.2 設定 API URL
1. 找到這一行：
   ```typescript
   const API_URL = '請替換為你的 Google Apps Script Web App URL';
   ```
2. 將 `'請替換為你的 Google Apps Script Web App URL'` 替換為你在步驟 3.4 取得的 Web App URL
3. 例如：
   ```typescript
   const API_URL = 'https://script.google.com/macros/s/AKfycbyyfLr8CnSroku2PCXJfO_e8sUoy8Dh6CjCQ88L-_b71Phi69p9v4naV1Xi30qISQw8/exec';
   ```

---

## 📝 步驟 5：修改前端代碼整合 API

### 5.1 匯入 API 函數
在 `html` 檔案（或你的主要 React 元件檔案）頂部加入：

```typescript
import { 
  createTask, 
  updateTaskStatus, 
  updateTaskResponse, 
  addEvidence, 
  deleteEvidence, 
  getTasks, 
  getUsers 
} from './api';
```

### 5.2 修改 App 元件載入資料
將原本的 `useState` 改為從 API 載入：

```typescript
// 原本：
const [tasks, setTasks] = useState(INITIAL_TASKS);

// 改為：
const [tasks, setTasks] = useState([]);
const [users, setUsers] = useState(USERS); // 或從 API 載入
const [loading, setLoading] = useState(true);

useEffect(() => {
  // 載入任務列表
  loadTasks();
  // 載入人員列表（可選）
  loadUsers();
}, []);

const loadTasks = async () => {
  setLoading(true);
  const result = await getTasks(selectedRole);
  if (result.success && result.data) {
    setTasks(result.data);
  }
  setLoading(false);
};

const loadUsers = async () => {
  const result = await getUsers();
  if (result.success && result.data) {
    setUsers(result.data);
  }
};
```

### 5.3 修改建立任務功能
在 `handleCreateTask` 函數中加入 API 呼叫：

```typescript
const handleCreateTask = async (newTaskData) => {
  const result = await createTask(newTaskData);
  if (result.success) {
    // 重新載入任務列表
    await loadTasks();
    setView('dashboard');
  } else {
    alert('建立任務失敗：' + result.error);
  }
};
```

### 5.4 修改更新任務狀態
在 `handleUpdateStatus` 函數中加入 API 呼叫：

```typescript
const handleUpdateStatus = async (taskId, status) => {
  const result = await updateTaskStatus(taskId, status);
  if (result.success) {
    // 重新載入任務列表
    await loadTasks();
  } else {
    alert('更新狀態失敗：' + result.error);
  }
};
```

### 5.5 修改更新承辦人回覆
在 `handleUpdateResponse` 函數中加入 API 呼叫：

```typescript
const handleUpdateResponse = async (taskId, response) => {
  const result = await updateTaskResponse(taskId, response);
  if (result.success) {
    // 重新載入任務列表
    await loadTasks();
  } else {
    alert('更新回覆失敗：' + result.error);
  }
};
```

### 5.6 修改新增佐證資料
在 `handleAddEvidence` 函數中加入 API 呼叫：

```typescript
const handleAddEvidence = async (taskId, type) => {
  // ... 建立 evidence 物件的邏輯 ...
  
  if (newEvidence) {
    const result = await addEvidence(taskId, newEvidence);
    if (result.success) {
      // 重新載入任務列表
      await loadTasks();
    } else {
      alert('新增佐證失敗：' + result.error);
    }
  }
};
```

### 5.7 修改刪除佐證資料
在 `handleDeleteEvidence` 函數中加入 API 呼叫：

```typescript
const handleDeleteEvidence = async (taskId, evidenceId) => {
  const result = await deleteEvidence(taskId, evidenceId);
  if (result.success) {
    // 重新載入任務列表
    await loadTasks();
  } else {
    alert('刪除佐證失敗：' + result.error);
  }
};
```

---

## 📝 步驟 6：測試

### 6.1 測試建立任務
1. 啟動前端應用程式
2. 點擊「交辦任務」
3. 填寫表單並提交
4. 檢查 Google Sheets 是否有新資料

### 6.2 測試查詢任務
1. 重新整理頁面
2. 確認任務列表正確顯示

### 6.3 測試更新功能
1. 點擊任務卡片展開
2. 更新狀態或回覆
3. 檢查 Google Sheets 是否更新

### 6.4 檢查錯誤
1. 開啟瀏覽器開發者工具（F12）
2. 查看 Console 標籤是否有錯誤訊息
3. 查看 Network 標籤確認 API 請求是否成功

---

## 🔧 疑難排解

### 問題 1：CORS 錯誤
**症狀**：瀏覽器 Console 顯示 CORS 相關錯誤

**解決方案**：
1. 確認 Google Apps Script 部署時選擇「具有存取權的使用者：任何人」
2. 重新部署 Web App（每次修改程式碼後都需要重新部署）

### 問題 2：找不到試算表
**症狀**：API 回應錯誤「找不到試算表」

**解決方案**：
1. 確認 `Code.gs` 中的 `SPREADSHEET_ID` 是否正確
2. 確認試算表的權限設定（至少要有編輯權限）

### 問題 3：資料沒有儲存
**症狀**：提交任務後，Sheets 沒有新資料

**解決方案**：
1. 檢查 Apps Script 的執行記錄（檢視 → 執行記錄）
2. 確認是否有錯誤訊息
3. 確認工作表名稱是否正確（預設為「交辦紀錄」）

### 問題 4：API URL 錯誤
**症狀**：無法連接到後端

**解決方案**：
1. 確認 `api.ts` 中的 `API_URL` 是否正確
2. 確認 Web App 已正確部署
3. 測試直接訪問 Web App URL（應該會看到 JSON 回應）

---

## ✅ 完成檢查清單

- [ ] Google Sheets 試算表已建立
- [ ] 試算表 ID 已記錄
- [ ] Google Apps Script 專案已建立
- [ ] `Code.gs` 中的 `SPREADSHEET_ID` 已設定
- [ ] Web App 已部署
- [ ] Web App URL 已取得
- [ ] `api.ts` 中的 `API_URL` 已設定
- [ ] 前端代碼已修改為使用 API
- [ ] 測試建立任務功能
- [ ] 測試查詢任務功能
- [ ] 測試更新功能
- [ ] 沒有 Console 錯誤

---

## 🎉 完成！

現在你的前端應用程式已經成功串接到 Google Sheets 作為後端資料庫了！

如有問題，請參考「串接GoogleSheets準備清單.md」或檢查瀏覽器 Console 的錯誤訊息。

