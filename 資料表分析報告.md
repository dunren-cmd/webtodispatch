# WebToDispatch å°ˆæ¡ˆè³‡æ–™è¡¨åˆ†æå ±å‘Š

## ğŸ“Š è³‡æ–™è¡¨ç¸½è¦½

å°ˆæ¡ˆå…±ä½¿ç”¨ **3 å€‹ä¸»è¦è³‡æ–™è¡¨**ï¼š

| è¡¨å | ç”¨é€” | è¨˜éŒ„æ•¸ | ç‹€æ…‹ |
|------|------|--------|------|
| **users** | ç”¨æˆ¶/å“¡å·¥è³‡æ–™ | 114 | âœ… ä½¿ç”¨ä¸­ |
| **tasks** | ä»»å‹™äº¤è¾¦è¨˜éŒ„ | 5 | âœ… ä½¿ç”¨ä¸­ |
| **roles** | è§’è‰²å®šç¾© | 19 | âœ… ä½¿ç”¨ä¸­ |

---

## ğŸ“‹ è©³ç´°è³‡æ–™è¡¨çµæ§‹

### 1. usersï¼ˆç”¨æˆ¶è¡¨ï¼‰

**ç”¨é€”**ï¼šå„²å­˜ç³»çµ±ä¸­çš„æ‰€æœ‰ç”¨æˆ¶/å“¡å·¥è³‡è¨Š

**æ¬„ä½çµæ§‹**ï¼š

| æ¬„ä½åç¨± | é¡å‹ | ç´„æŸ | èªªæ˜ |
|---------|------|------|------|
| `id` | BIGINT | PRIMARY KEY | ç”¨æˆ¶å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `timestamp` | TIMESTAMPTZ | DEFAULT NOW() | å»ºç«‹æ™‚é–“æˆ³è¨˜ |
| `name` | TEXT | NOT NULL | ç”¨æˆ¶å§“å |
| `role` | TEXT | FOREIGN KEY â†’ roles.id | è§’è‰²IDï¼ˆå¤–éµï¼‰ |
| `level` | INTEGER | DEFAULT 4, CHECK (1-4) | å±¤ç´šï¼ˆ1=æœ€é«˜ï¼Œ4=å“¡å·¥ï¼‰ |
| `Mail` | TEXT | NULL | é›»å­éƒµä»¶åœ°å€ |
| `ID4` | INTEGER | NULL | å“¡å·¥ç·¨è™Ÿ |
| `headshot` | TEXT | NULL | é ­åƒ/ç…§ç‰‡é€£çµ |

**ç´¢å¼•**ï¼š
- `idx_users_level` - å±¤ç´šç´¢å¼•
- `idx_users_mail` - é›»å­éƒµä»¶ç´¢å¼•
- `idx_users_employee_id` - å“¡å·¥IDç´¢å¼•
- `idx_users_role` - è§’è‰²ç´¢å¼•

**é—œè¯é—œä¿‚**ï¼š
- `users.role` â†’ `roles.id` (å¤–éµï¼Œä¸€å°å¤š)

**API ä½¿ç”¨**ï¼š
- `GET /rest/v1/users` - å–å¾—æ‰€æœ‰ç”¨æˆ¶
- `POST /rest/v1/users` - å»ºç«‹æ–°ç”¨æˆ¶
- `PATCH /rest/v1/users?id=eq.{id}` - æ›´æ–°ç”¨æˆ¶
- `DELETE /rest/v1/users?id=eq.{id}` - åˆªé™¤ç”¨æˆ¶
- `GET /rest/v1/users?select=role` - å–å¾—è§’è‰²åˆ—è¡¨

**ä¸»è¦åŠŸèƒ½**ï¼š
- äººå“¡ç®¡ç†
- è§’è‰²åˆ†é…
- ç”¨æˆ¶æŸ¥è©¢

---

### 2. tasksï¼ˆä»»å‹™è¡¨ï¼‰

**ç”¨é€”**ï¼šå„²å­˜ä»»å‹™äº¤è¾¦è¨˜éŒ„å’Œè¿½è¹¤è³‡è¨Š

**æ¬„ä½çµæ§‹**ï¼š

| æ¬„ä½åç¨± | é¡å‹ | ç´„æŸ | èªªæ˜ |
|---------|------|------|------|
| `id` | BIGINT | PRIMARY KEY | ä»»å‹™å”¯ä¸€è­˜åˆ¥ç¢¼ |
| `timestamp` | TIMESTAMPTZ | DEFAULT NOW() | å»ºç«‹æ™‚é–“æˆ³è¨˜ |
| `title` | TEXT | NOT NULL | ä»»å‹™æ¨™é¡Œ |
| `description` | TEXT | NULL | ä»»å‹™æè¿° |
| `assigner_id` | BIGINT | NULL | äº¤è¾¦äººID |
| `assigner_name` | TEXT | NULL | äº¤è¾¦äººå§“å |
| `assignee_id` | BIGINT | NULL | æ‰¿è¾¦äººID |
| `assignee_name` | TEXT | NULL | æ‰¿è¾¦äººå§“å |
| `collaborator_ids` | JSONB | DEFAULT '[]' | å”ä½œè€…IDåˆ—è¡¨ï¼ˆJSONé™£åˆ—ï¼‰ |
| `role_category` | TEXT | NULL | è§’è‰²é¡åˆ¥ |
| `plan_date` | DATE | NULL | è¨ˆåŠƒæ—¥æœŸ |
| `interim_date` | DATE | NULL | æœŸä¸­æª¢æŸ¥æ—¥æœŸ |
| `final_date` | DATE | NULL | æœ€çµ‚å®Œæˆæ—¥æœŸ |
| `status` | TEXT | DEFAULT 'pending' | ç‹€æ…‹ï¼ˆpending/in_progress/done/overdueï¼‰ |
| `assignee_response` | TEXT | NULL | æ‰¿è¾¦äººå›è¦†å…§å®¹ |
| `evidence` | JSONB | DEFAULT '[]' | ä½è­‰è³‡æ–™ï¼ˆJSONé™£åˆ—ï¼‰ |

**ç´¢å¼•**ï¼š
- `idx_tasks_role_category` - è§’è‰²é¡åˆ¥ç´¢å¼•
- `idx_tasks_status` - ç‹€æ…‹ç´¢å¼•
- `idx_tasks_assignee_id` - æ‰¿è¾¦äººIDç´¢å¼•
- `idx_tasks_assigner_id` - äº¤è¾¦äººIDç´¢å¼•

**é—œè¯é—œä¿‚**ï¼š
- `tasks.assigner_id` â†’ `users.id` (é‚è¼¯é—œè¯)
- `tasks.assignee_id` â†’ `users.id` (é‚è¼¯é—œè¯)

**API ä½¿ç”¨**ï¼š
- `GET /rest/v1/tasks` - å–å¾—æ‰€æœ‰ä»»å‹™
- `GET /rest/v1/tasks?role_category=eq.{category}` - ä¾è§’è‰²é¡åˆ¥ç¯©é¸
- `POST /rest/v1/tasks` - å»ºç«‹æ–°ä»»å‹™
- `PATCH /rest/v1/tasks?id=eq.{id}` - æ›´æ–°ä»»å‹™
- `DELETE /rest/v1/tasks?id=eq.{id}` - åˆªé™¤ä»»å‹™

**ä¸»è¦åŠŸèƒ½**ï¼š
- ä»»å‹™å»ºç«‹èˆ‡ç®¡ç†
- ä»»å‹™ç‹€æ…‹è¿½è¹¤
- ä½è­‰è³‡æ–™ç®¡ç†
- ä»»å‹™æŸ¥è©¢èˆ‡ç¯©é¸

---

### 3. rolesï¼ˆè§’è‰²è¡¨ï¼‰

**ç”¨é€”**ï¼šå®šç¾©ç³»çµ±ä¸­çš„è§’è‰²è³‡è¨Šï¼ŒåŒ…æ‹¬è§’è‰²åç¨±ã€å±¤ç´šã€åœ–ç¤ºç­‰

**æ¬„ä½çµæ§‹**ï¼š

| æ¬„ä½åç¨± | é¡å‹ | ç´„æŸ | èªªæ˜ |
|---------|------|------|------|
| `id` | TEXT | PRIMARY KEY | è§’è‰²IDï¼ˆä¸»éµï¼‰ |
| `name` | TEXT | NOT NULL | è§’è‰²åç¨± |
| `icon_name` | TEXT | DEFAULT 'Briefcase' | åœ–ç¤ºåç¨± |
| `color` | TEXT | DEFAULT 'bg-blue-100 text-blue-700' | é¡è‰²ä¸»é¡Œï¼ˆTailwind CSSï¼‰ |
| `level` | INTEGER | DEFAULT 4, CHECK (1-4) | å±¤ç´šï¼ˆ1=æœ€é«˜ï¼Œ4=å“¡å·¥ï¼‰ |
| `webhook` | TEXT | NULL | Webhook URLï¼ˆç”¨æ–¼é€šçŸ¥ï¼‰ |
| `is_default` | BOOLEAN | DEFAULT false | æ˜¯å¦ç‚ºé è¨­è§’è‰² |
| `created_at` | TIMESTAMPTZ | DEFAULT NOW() | å»ºç«‹æ™‚é–“ |
| `updated_at` | TIMESTAMPTZ | DEFAULT NOW() | æ›´æ–°æ™‚é–“ |

**ç´¢å¼•**ï¼š
- `idx_roles_level` - å±¤ç´šç´¢å¼•
- `idx_roles_is_default` - é è¨­è§’è‰²ç´¢å¼•
- `idx_roles_webhook` - Webhookç´¢å¼•ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰

**é—œè¯é—œä¿‚**ï¼š
- `users.role` â†’ `roles.id` (å¤–éµï¼Œä¸€å°å¤š)
- ä¸€å€‹è§’è‰²å¯ä»¥å°æ‡‰å¤šå€‹ç”¨æˆ¶

**API ä½¿ç”¨**ï¼š
- `GET /rest/v1/roles` - å–å¾—æ‰€æœ‰è§’è‰²
- `GET /rest/v1/roles?order=name.asc` - å–å¾—æ’åºå¾Œçš„è§’è‰²åˆ—è¡¨
- `POST /rest/v1/roles` - å»ºç«‹æ–°è§’è‰²
- `PATCH /rest/v1/roles?id=eq.{id}` - æ›´æ–°è§’è‰²
- `DELETE /rest/v1/roles?id=eq.{id}` - åˆªé™¤è§’è‰²

**ä¸»è¦åŠŸèƒ½**ï¼š
- è§’è‰²å®šç¾©èˆ‡ç®¡ç†
- è§’è‰²å±¤ç´šç®¡ç†
- Webhook è¨­å®šï¼ˆç”¨æ–¼ä»»å‹™é€šçŸ¥ï¼‰

---

## ğŸ”— è³‡æ–™è¡¨é—œè¯åœ–

```
roles (ä¸€)
  â”‚
  â”‚ (users.role â†’ roles.id)
  â”‚
  â””â”€â”€â”€< users (å¤š)
         â”‚
         â”‚ (tasks.assigner_id â†’ users.id)
         â”‚ (tasks.assignee_id â†’ users.id)
         â”‚
         â””â”€â”€â”€< tasks (å¤š)
```

**é—œè¯èªªæ˜**ï¼š
1. **roles â†” users**ï¼šä¸€å°å¤šé—œä¿‚
   - ä¸€å€‹è§’è‰²å¯ä»¥æœ‰å¤šå€‹ç”¨æˆ¶
   - ç”¨æˆ¶çš„ `role` æ¬„ä½æ˜¯å¤–éµï¼ŒæŒ‡å‘ `roles.id`
   - ç•¶è§’è‰²è¢«åˆªé™¤æ™‚ï¼Œç”¨æˆ¶çš„ `role` æœƒè¨­ç‚º NULLï¼ˆON DELETE SET NULLï¼‰

2. **users â†” tasks**ï¼šé‚è¼¯é—œè¯ï¼ˆç„¡å¤–éµç´„æŸï¼‰
   - `tasks.assigner_id` å°æ‡‰ `users.id`ï¼ˆäº¤è¾¦äººï¼‰
   - `tasks.assignee_id` å°æ‡‰ `users.id`ï¼ˆæ‰¿è¾¦äººï¼‰
   - ä¸€å€‹ç”¨æˆ¶å¯ä»¥æœ‰å¤šå€‹ä»»å‹™ï¼ˆä½œç‚ºäº¤è¾¦äººæˆ–æ‰¿è¾¦äººï¼‰

---

## ğŸ“ˆ è³‡æ–™è¡¨ä½¿ç”¨çµ±è¨ˆ

### ç•¶å‰è³‡æ–™é‡

| è¡¨å | è¨˜éŒ„æ•¸ | èªªæ˜ |
|------|--------|------|
| users | 114 | ç³»çµ±ä¸­çš„ç”¨æˆ¶/å“¡å·¥ |
| tasks | 5 | ä»»å‹™äº¤è¾¦è¨˜éŒ„ |
| roles | 19 | è§’è‰²å®šç¾© |

### è³‡æ–™è¡¨å¤§å°ä¼°ç®—

- **users**ï¼šç´„ 16KBï¼ˆ114 ç­†è¨˜éŒ„ï¼‰
- **tasks**ï¼šç´„ 1.1KBï¼ˆ5 ç­†è¨˜éŒ„ï¼‰
- **roles**ï¼šç´„ 3.1KBï¼ˆ19 ç­†è¨˜éŒ„ï¼‰

---

## ğŸ” API ç«¯é»ä½¿ç”¨åˆ†æ

### users è¡¨ API ç«¯é»

| æ–¹æ³• | ç«¯é» | åŠŸèƒ½ | ä½¿ç”¨é »ç‡ |
|------|------|------|---------|
| GET | `/rest/v1/users` | å–å¾—æ‰€æœ‰ç”¨æˆ¶ | é«˜ |
| GET | `/rest/v1/users?select=role` | å–å¾—è§’è‰²åˆ—è¡¨ | ä¸­ |
| POST | `/rest/v1/users` | å»ºç«‹æ–°ç”¨æˆ¶ | ä½ |
| PATCH | `/rest/v1/users?id=eq.{id}` | æ›´æ–°ç”¨æˆ¶ | ä¸­ |
| DELETE | `/rest/v1/users?id=eq.{id}` | åˆªé™¤ç”¨æˆ¶ | ä½ |

### tasks è¡¨ API ç«¯é»

| æ–¹æ³• | ç«¯é» | åŠŸèƒ½ | ä½¿ç”¨é »ç‡ |
|------|------|------|---------|
| GET | `/rest/v1/tasks` | å–å¾—æ‰€æœ‰ä»»å‹™ | é«˜ |
| GET | `/rest/v1/tasks?role_category=eq.{category}` | ä¾è§’è‰²ç¯©é¸ | é«˜ |
| POST | `/rest/v1/tasks` | å»ºç«‹æ–°ä»»å‹™ | ä¸­ |
| PATCH | `/rest/v1/tasks?id=eq.{id}` | æ›´æ–°ä»»å‹™ç‹€æ…‹/å…§å®¹ | é«˜ |
| DELETE | `/rest/v1/tasks?id=eq.{id}` | åˆªé™¤ä»»å‹™ | ä½ |

### roles è¡¨ API ç«¯é»

| æ–¹æ³• | ç«¯é» | åŠŸèƒ½ | ä½¿ç”¨é »ç‡ |
|------|------|------|---------|
| GET | `/rest/v1/roles` | å–å¾—æ‰€æœ‰è§’è‰² | ä¸­ |
| GET | `/rest/v1/roles?order=name.asc` | å–å¾—æ’åºå¾Œçš„è§’è‰² | ä¸­ |
| POST | `/rest/v1/roles` | å»ºç«‹æ–°è§’è‰² | ä½ |
| PATCH | `/rest/v1/roles?id=eq.{id}` | æ›´æ–°è§’è‰² | ä¸­ |
| DELETE | `/rest/v1/roles?id=eq.{id}` | åˆªé™¤è§’è‰² | ä½ |

---

## ğŸ” å®‰å…¨æ€§è¨­å®š

### Row Level Security (RLS)

æ‰€æœ‰è³‡æ–™è¡¨éƒ½å•Ÿç”¨äº† RLSï¼š

- **users**ï¼šå•Ÿç”¨ RLS
- **tasks**ï¼šå•Ÿç”¨ RLS
- **roles**ï¼šå•Ÿç”¨ RLS

### RLS æ”¿ç­–

ç›®å‰æ‰€æœ‰è¡¨éƒ½ä½¿ç”¨å¯¬é¬†çš„æ”¿ç­–ï¼ˆå…è¨±æ‰€æœ‰äººè®€å¯«ï¼‰ï¼š

```sql
CREATE POLICY "Allow all operations on {table}" ON {table}
  FOR ALL USING (true) WITH CHECK (true);
```

**æ³¨æ„**ï¼šç”Ÿç”¢ç’°å¢ƒæ‡‰æ ¹æ“šå¯¦éš›éœ€æ±‚èª¿æ•´å®‰å…¨æ”¿ç­–ã€‚

---

## ğŸ“ è³‡æ–™è¡¨æ¼”é€²æ­·å²

### é·ç§»æ–‡ä»¶é †åº

1. **20251212134638_init.sql**
   - å‰µå»º `users` å’Œ `tasks` è¡¨ï¼ˆåŸºæœ¬çµæ§‹ï¼‰
   - æ¬„ä½ï¼šid, timestamp, name, role, avatar

2. **20251212170000_merge_personnel_to_users.sql**
   - æ·»åŠ  `mail`, `employee_id`, `headshot` æ¬„ä½
   - åˆä½µ PersonnelData è¡¨åˆ° users

3. **20251213000000_change_avatar_to_level.sql**
   - æ·»åŠ  `level` æ¬„ä½
   - ç§»é™¤ `avatar` æ¬„ä½

4. **20251213120000_update_level5_to_level4.sql**
   - å°‡ level 5 çµ±ä¸€æ”¹ç‚º 4

5. **20251214000000_fix_users_table_structure.sql**
   - ä¿®å¾© users è¡¨çµæ§‹
   - ç¢ºä¿æ‰€æœ‰æ¬„ä½å­˜åœ¨

6. **20251215000000_create_roles_table.sql**
   - å‰µå»º `roles` è¡¨
   - å»ºç«‹ users.role â†’ roles.id å¤–éµé—œè¯

### å·²å»¢æ£„çš„è¡¨

- **PersonnelData**ï¼šå·²åˆä½µåˆ° `users` è¡¨
- **avatar æ¬„ä½**ï¼šå·²è¢« `level` æ¬„ä½å–ä»£

---

## ğŸ¯ è³‡æ–™è¡¨ä½¿ç”¨å ´æ™¯

### 1. ç”¨æˆ¶ç®¡ç†å ´æ™¯

- **æŸ¥è©¢ç”¨æˆ¶åˆ—è¡¨**ï¼š`GET /rest/v1/users`
- **æ–°å¢ç”¨æˆ¶**ï¼š`POST /rest/v1/users`
- **æ›´æ–°ç”¨æˆ¶è³‡è¨Š**ï¼š`PATCH /rest/v1/users?id=eq.{id}`
- **åˆªé™¤ç”¨æˆ¶**ï¼š`DELETE /rest/v1/users?id=eq.{id}`

### 2. ä»»å‹™ç®¡ç†å ´æ™¯

- **å»ºç«‹ä»»å‹™**ï¼š`POST /rest/v1/tasks`
- **æŸ¥è©¢ä»»å‹™åˆ—è¡¨**ï¼š`GET /rest/v1/tasks`
- **ä¾è§’è‰²ç¯©é¸ä»»å‹™**ï¼š`GET /rest/v1/tasks?role_category=eq.{category}`
- **æ›´æ–°ä»»å‹™ç‹€æ…‹**ï¼š`PATCH /rest/v1/tasks?id=eq.{id}`
- **æ–°å¢ä½è­‰è³‡æ–™**ï¼šæ›´æ–° `evidence` JSONB æ¬„ä½

### 3. è§’è‰²ç®¡ç†å ´æ™¯

- **å–å¾—è§’è‰²åˆ—è¡¨**ï¼š`GET /rest/v1/roles`
- **å»ºç«‹æ–°è§’è‰²**ï¼š`POST /rest/v1/roles`
- **æ›´æ–°è§’è‰²è³‡è¨Š**ï¼š`PATCH /rest/v1/roles?id=eq.{id}`
- **è¨­å®š Webhook**ï¼šæ›´æ–° `webhook` æ¬„ä½

---

## ğŸ“Š è³‡æ–™è¡¨è¨­è¨ˆç‰¹é»

### å„ªé»

1. **æ¸…æ™°çš„é—œè¯é—œä¿‚**ï¼šroles å’Œ users ä¹‹é–“æœ‰æ˜ç¢ºçš„å¤–éµé—œè¯
2. **éˆæ´»çš„è³‡æ–™çµæ§‹**ï¼šä½¿ç”¨ JSONB å„²å­˜è¤‡é›œè³‡æ–™ï¼ˆcollaborator_ids, evidenceï¼‰
3. **å®Œæ•´çš„ç´¢å¼•**ï¼šé‡å°å¸¸ç”¨æŸ¥è©¢æ¬„ä½å»ºç«‹ç´¢å¼•
4. **æ™‚é–“æˆ³è¨˜**ï¼šæ‰€æœ‰è¡¨éƒ½æœ‰ timestamp æ¬„ä½è¿½è¹¤å»ºç«‹æ™‚é–“

### æ³¨æ„äº‹é …

1. **å¤–éµç´„æŸ**ï¼šusers.role å¿…é ˆå­˜åœ¨æ–¼ roles.idï¼Œå¦å‰‡æœƒå°è‡´æ’å…¥å¤±æ•—
2. **JSONB æ¬„ä½**ï¼šcollaborator_ids å’Œ evidence éœ€è¦æ­£ç¢ºçš„ JSON æ ¼å¼
3. **ç‹€æ…‹å€¼**ï¼štasks.status æ‡‰ä½¿ç”¨é å®šç¾©çš„å€¼ï¼ˆpending/in_progress/done/overdueï¼‰
4. **å±¤ç´šç¯„åœ**ï¼šusers.level å’Œ roles.level å¿…é ˆåœ¨ 1-4 ç¯„åœå…§

---

## ğŸ”§ ç¶­è­·å»ºè­°

### å®šæœŸç¶­è­·

1. **æ¸…ç†èˆŠè³‡æ–™**ï¼šå®šæœŸæ¸…ç†å·²å®Œæˆçš„ä»»å‹™ï¼ˆå¦‚æœéœ€è¦ï¼‰
2. **ç´¢å¼•å„ªåŒ–**ï¼šç›£æ§æŸ¥è©¢æ•ˆèƒ½ï¼Œé©æ™‚èª¿æ•´ç´¢å¼•
3. **è³‡æ–™å‚™ä»½**ï¼šå®šæœŸå‚™ä»½é‡è¦è³‡æ–™

### æ•ˆèƒ½å„ªåŒ–

1. **ä½¿ç”¨ç´¢å¼•**ï¼šæŸ¥è©¢æ™‚å–„ç”¨å·²å»ºç«‹çš„ç´¢å¼•
2. **æ‰¹æ¬¡æ“ä½œ**ï¼šå¤§é‡è³‡æ–™æ“ä½œæ™‚ä½¿ç”¨æ‰¹æ¬¡ API
3. **æŸ¥è©¢å„ªåŒ–**ï¼šä½¿ç”¨ `select` åƒæ•¸åªå–å¾—éœ€è¦çš„æ¬„ä½

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [è³‡æ–™åº«çµæ§‹èªªæ˜](./supabase_schema.sql)
- [é·ç§»æ–‡ä»¶](./supabase/migrations/)
- [API æ–‡ä»¶](./api.ts)
- [è§’è‰²é—œè¯èªªæ˜](./roles_usersé—œè¯èªªæ˜.md)

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-12-18
**å°ˆæ¡ˆç‰ˆæœ¬**ï¼šWebToDispatch_2
