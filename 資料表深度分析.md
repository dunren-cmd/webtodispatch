# WebToDispatch è³‡æ–™è¡¨æ·±åº¦åˆ†æž

## ðŸ“Š è³‡æ–™è¡¨ç¸½è¦½

å°ˆæ¡ˆä½¿ç”¨ **3 å€‹æ ¸å¿ƒè³‡æ–™è¡¨**ï¼Œæ§‹æˆå®Œæ•´çš„ä»»å‹™äº¤è¾¦ç³»çµ±ï¼š

**æ³¨æ„**ï¼š`personnel` è¡¨å’Œ `user_with_personnel` è¦–åœ–å·²ç§»é™¤ï¼Œè³‡æ–™å·²åˆä½µåˆ° `users` è¡¨ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  roles  â”‚ (è§’è‰²å®šç¾©è¡¨)
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ 1
     â”‚
     â”‚ N (å¤–éµ: users.role â†’ roles.id)
     â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚  users  â”‚ (ç”¨æˆ¶/å“¡å·¥è¡¨)
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ N
     â”‚
     â”‚ (é‚è¼¯é—œè¯: tasks.assigner_id, tasks.assignee_id â†’ users.id)
     â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚  tasks  â”‚ (ä»»å‹™è¡¨)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“‹ è©³ç´°è³‡æ–™è¡¨åˆ†æž

### 1. usersï¼ˆç”¨æˆ¶è¡¨ï¼‰

#### è¡¨çµæ§‹å®šç¾©

```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  name TEXT NOT NULL,
  role TEXT,                    -- å¤–éµ â†’ roles.id
  level INTEGER DEFAULT 4 CHECK (level >= 1 AND level <= 4),
  Mail TEXT,                   -- æ³¨æ„ï¼šå¤§å¯« M
  ID4 INTEGER,                 -- æ³¨æ„ï¼šå¤§å¯« ID4
  headshot TEXT
);
```

#### æ¬„ä½è©³ç´°èªªæ˜Ž

| æ¬„ä½ | é¡žåž‹ | ç´„æŸ | é è¨­å€¼ | èªªæ˜Ž | ç¯„ä¾‹ |
|------|------|------|--------|------|------|
| `id` | BIGINT | PRIMARY KEY | - | ç”¨æˆ¶å”¯ä¸€è­˜åˆ¥ç¢¼ | `1`, `1001` |
| `timestamp` | TIMESTAMPTZ | - | NOW() | å»ºç«‹æ™‚é–“ | `2025-12-17 00:00:00+00` |
| `name` | TEXT | NOT NULL | - | ç”¨æˆ¶å§“å | `"å¼µä¸‰"`, `"æŽå››"` |
| `role` | TEXT | FOREIGN KEY | NULL | è§’è‰²IDï¼ˆå¤–éµï¼‰ | `"é™¢é•·"`, `"ä¸»ä»»"` |
| `level` | INTEGER | CHECK (1-4) | 4 | å±¤ç´šï¼ˆ1=æœ€é«˜ï¼‰ | `1`, `2`, `3`, `4` |
| `Mail` | TEXT | - | NULL | é›»å­éƒµä»¶ | `"user@example.com"` |
| `ID4` | INTEGER | - | NULL | å“¡å·¥ç·¨è™Ÿ | `1`, `42` |
| `headshot` | TEXT | - | NULL | é ­åƒé€£çµ | `"https://drive.google.com/..."` |

#### ç´¢å¼•çµæ§‹

```sql
CREATE INDEX idx_users_level ON users(level);
CREATE INDEX idx_users_mail ON users(mail);
CREATE INDEX idx_users_employee_id ON users(employee_id);
CREATE INDEX idx_users_role ON users(role);
```

**ç´¢å¼•ç”¨é€”**ï¼š
- `idx_users_level`: å¿«é€ŸæŸ¥è©¢ç‰¹å®šå±¤ç´šçš„ç”¨æˆ¶
- `idx_users_mail`: å¿«é€ŸæŸ¥æ‰¾ç”¨æˆ¶é›»å­éƒµä»¶
- `idx_users_role`: å¿«é€ŸæŸ¥è©¢ç‰¹å®šè§’è‰²çš„ç”¨æˆ¶
- `idx_users_employee_id`: å¿«é€ŸæŸ¥æ‰¾å“¡å·¥ç·¨è™Ÿ

#### è³‡æ–™å®Œæ•´æ€§ç´„æŸ

1. **å¤–éµç´„æŸ**ï¼š
   ```sql
   FOREIGN KEY (role) REFERENCES roles(id) 
   ON DELETE SET NULL 
   ON UPDATE CASCADE
   ```
   - ç•¶è§’è‰²è¢«åˆªé™¤æ™‚ï¼Œç”¨æˆ¶çš„ `role` è¨­ç‚º NULL
   - ç•¶è§’è‰² ID æ›´æ–°æ™‚ï¼Œè‡ªå‹•æ›´æ–°ç”¨æˆ¶çš„ `role`

2. **æª¢æŸ¥ç´„æŸ**ï¼š
   ```sql
   CHECK (level >= 1 AND level <= 4)
   ```
   - `level` å¿…é ˆåœ¨ 1-4 ç¯„åœå…§
   - ç³»çµ±æœƒè‡ªå‹•å°‡ 5 è½‰æ›ç‚º 4

#### è³‡æ–™ç¯„ä¾‹

```json
{
  "id": 1,
  "timestamp": "2025-12-17T00:00:00+00:00",
  "name": "èƒ¡å»¶å¿ ",
  "role": "é™¢é•·",
  "level": 1,
  "Mail": "yenchunghu@gmail.com",
  "ID4": 1,
  "headshot": "https://drive.google.com/file/d/13OzposAMDYVo69Uxm66JFP1QbRSCZFQP/view"
}
```

#### API ä½¿ç”¨æ¨¡å¼

**æŸ¥è©¢æ‰€æœ‰ç”¨æˆ¶**ï¼š
```typescript
GET /rest/v1/users
```

**æŸ¥è©¢ç‰¹å®šå±¤ç´šçš„ç”¨æˆ¶**ï¼š
```typescript
GET /rest/v1/users?level=eq.1
```

**æŸ¥è©¢ç‰¹å®šè§’è‰²çš„ç”¨æˆ¶**ï¼š
```typescript
GET /rest/v1/users?role=eq.é™¢é•·
```

**å–å¾—ä¸é‡è¤‡çš„è§’è‰²åˆ—è¡¨**ï¼š
```typescript
GET /rest/v1/users?select=role
```

---

### 2. tasksï¼ˆä»»å‹™è¡¨ï¼‰

#### è¡¨çµæ§‹å®šç¾©

```sql
CREATE TABLE tasks (
  id BIGINT PRIMARY KEY,
  timestamp TIMESTAMPTZ DEFAULT NOW(),
  title TEXT NOT NULL,
  description TEXT,
  assigner_id BIGINT,           -- é‚è¼¯é—œè¯ â†’ users.id
  assigner_name TEXT,
  assignee_id BIGINT,           -- é‚è¼¯é—œè¯ â†’ users.id
  assignee_name TEXT,
  collaborator_ids JSONB DEFAULT '[]'::jsonb,
  role_category TEXT,
  plan_date DATE,
  interim_date DATE,
  final_date DATE,
  status TEXT DEFAULT 'pending',
  assignee_response TEXT,
  evidence JSONB DEFAULT '[]'::jsonb
);
```

#### æ¬„ä½è©³ç´°èªªæ˜Ž

| æ¬„ä½ | é¡žåž‹ | ç´„æŸ | é è¨­å€¼ | èªªæ˜Ž | ç¯„ä¾‹ |
|------|------|------|--------|------|------|
| `id` | BIGINT | PRIMARY KEY | - | ä»»å‹™å”¯ä¸€è­˜åˆ¥ç¢¼ | `1734567890123` |
| `timestamp` | TIMESTAMPTZ | - | NOW() | å»ºç«‹æ™‚é–“ | `2025-12-18 16:00:00+00` |
| `title` | TEXT | NOT NULL | - | ä»»å‹™æ¨™é¡Œ | `"å®Œæˆå­£åº¦å ±å‘Š"` |
| `description` | TEXT | - | NULL | ä»»å‹™æè¿° | `"æ’°å¯«ä¸¦æäº¤Q4å ±å‘Š"` |
| `assigner_id` | BIGINT | - | NULL | äº¤è¾¦äººID | `1`, `1001` |
| `assigner_name` | TEXT | - | NULL | äº¤è¾¦äººå§“å | `"å¼µä¸‰"` |
| `assignee_id` | BIGINT | - | NULL | æ‰¿è¾¦äººID | `2`, `2001` |
| `assignee_name` | TEXT | - | NULL | æ‰¿è¾¦äººå§“å | `"æŽå››"` |
| `collaborator_ids` | JSONB | - | `[]` | å”ä½œè€…IDåˆ—è¡¨ | `[3, 4, 5]` |
| `role_category` | TEXT | - | NULL | è§’è‰²é¡žåˆ¥ | `"ç®¡ç†"`, `"è²¡å‹™"` |
| `plan_date` | DATE | - | NULL | è¨ˆåŠƒæ—¥æœŸ | `2025-12-20` |
| `interim_date` | DATE | - | NULL | æœŸä¸­æª¢æŸ¥æ—¥æœŸ | `2025-12-25` |
| `final_date` | DATE | - | NULL | æœ€çµ‚å®Œæˆæ—¥æœŸ | `2025-12-30` |
| `status` | TEXT | - | `'pending'` | ä»»å‹™ç‹€æ…‹ | `pending`, `in_progress`, `done`, `overdue` |
| `assignee_response` | TEXT | - | NULL | æ‰¿è¾¦äººå›žè¦† | `"å·²å®Œæˆåˆæ­¥åˆ†æž"` |
| `evidence` | JSONB | - | `[]` | ä½è­‰è³‡æ–™ | `[{"id":"1","type":"image","url":"..."}]` |

#### JSONB æ¬„ä½çµæ§‹

**collaborator_idsï¼ˆå”ä½œè€…IDåˆ—è¡¨ï¼‰**ï¼š
```json
[1, 2, 3]
```

**evidenceï¼ˆä½è­‰è³‡æ–™ï¼‰**ï¼š
```json
[
  {
    "id": "evt_001",
    "type": "stat",
    "label": "å®ŒæˆçŽ‡",
    "value": "85%",
    "trend": "up"
  },
  {
    "id": "evt_002",
    "type": "image",
    "name": "æˆªåœ–.png",
    "url": "https://example.com/image.png"
  },
  {
    "id": "evt_003",
    "type": "link",
    "label": "ç›¸é—œæ–‡ä»¶",
    "url": "https://docs.example.com"
  }
]
```

#### ç´¢å¼•çµæ§‹

```sql
CREATE INDEX idx_tasks_role_category ON tasks(role_category);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_assignee_id ON tasks(assignee_id);
CREATE INDEX idx_tasks_assigner_id ON tasks(assigner_id);
```

**ç´¢å¼•ç”¨é€”**ï¼š
- `idx_tasks_role_category`: å¿«é€Ÿç¯©é¸ç‰¹å®šè§’è‰²é¡žåˆ¥çš„ä»»å‹™
- `idx_tasks_status`: å¿«é€ŸæŸ¥è©¢ç‰¹å®šç‹€æ…‹çš„ä»»å‹™
- `idx_tasks_assignee_id`: å¿«é€ŸæŸ¥æ‰¾æŸç”¨æˆ¶æ‰¿è¾¦çš„ä»»å‹™
- `idx_tasks_assigner_id`: å¿«é€ŸæŸ¥æ‰¾æŸç”¨æˆ¶äº¤è¾¦çš„ä»»å‹™

#### ç‹€æ…‹å€¼èªªæ˜Ž

| ç‹€æ…‹å€¼ | èªªæ˜Ž | ä½¿ç”¨å ´æ™¯ |
|--------|------|---------|
| `pending` | å¾…è™•ç† | ä»»å‹™å‰›å»ºç«‹ï¼Œå°šæœªé–‹å§‹ |
| `in_progress` | é€²è¡Œä¸­ | æ‰¿è¾¦äººå·²é–‹å§‹è™•ç† |
| `done` | å·²å®Œæˆ | ä»»å‹™å·²å®Œæˆ |
| `overdue` | é€¾æœŸ | è¶…éŽæœ€çµ‚æ—¥æœŸä»æœªå®Œæˆ |

#### API ä½¿ç”¨æ¨¡å¼

**æŸ¥è©¢æ‰€æœ‰ä»»å‹™**ï¼š
```typescript
GET /rest/v1/tasks
```

**ä¾è§’è‰²é¡žåˆ¥ç¯©é¸**ï¼š
```typescript
GET /rest/v1/tasks?role_category=eq.ç®¡ç†
```

**æŸ¥è©¢ç‰¹å®šç‹€æ…‹çš„ä»»å‹™**ï¼š
```typescript
GET /rest/v1/tasks?status=eq.pending
```

**æŸ¥è©¢æŸç”¨æˆ¶æ‰¿è¾¦çš„ä»»å‹™**ï¼š
```typescript
GET /rest/v1/tasks?assignee_id=eq.1
```

**æŸ¥è©¢æŸç”¨æˆ¶äº¤è¾¦çš„ä»»å‹™**ï¼š
```typescript
GET /rest/v1/tasks?assigner_id=eq.1
```

**å»ºç«‹æ–°ä»»å‹™**ï¼š
```typescript
POST /rest/v1/tasks
Content-Type: application/json

{
  "id": 1734567890123,
  "title": "å®Œæˆå­£åº¦å ±å‘Š",
  "description": "æ’°å¯«ä¸¦æäº¤Q4å ±å‘Š",
  "assigner_id": 1,
  "assigner_name": "å¼µä¸‰",
  "assignee_id": 2,
  "assignee_name": "æŽå››",
  "collaborator_ids": [3, 4],
  "role_category": "ç®¡ç†",
  "plan_date": "2025-12-20",
  "status": "pending"
}
```

---

### 3. rolesï¼ˆè§’è‰²è¡¨ï¼‰

#### è¡¨çµæ§‹å®šç¾©

```sql
CREATE TABLE roles (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  icon_name TEXT DEFAULT 'Briefcase',
  color TEXT DEFAULT 'bg-blue-100 text-blue-700',
  level INTEGER DEFAULT 4 CHECK (level >= 1 AND level <= 4),
  webhook TEXT,
  is_default BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### æ¬„ä½è©³ç´°èªªæ˜Ž

| æ¬„ä½ | é¡žåž‹ | ç´„æŸ | é è¨­å€¼ | èªªæ˜Ž | ç¯„ä¾‹ |
|------|------|------|--------|------|------|
| `id` | TEXT | PRIMARY KEY | - | è§’è‰²IDï¼ˆä¸»éµï¼‰ | `"é™¢é•·"`, `"ä¸»ä»»"` |
| `name` | TEXT | NOT NULL | - | è§’è‰²åç¨± | `"é™¢é•·"`, `"è²¡å‹™éƒ¨é–€"` |
| `icon_name` | TEXT | - | `'Briefcase'` | åœ–ç¤ºåç¨±ï¼ˆLucide Reactï¼‰ | `'Briefcase'`, `'Calculator'` |
| `color` | TEXT | - | `'bg-blue-100 text-blue-700'` | Tailwind CSS é¡è‰²é¡ž | `'bg-blue-100 text-blue-700'` |
| `level` | INTEGER | CHECK (1-4) | 4 | å±¤ç´šï¼ˆ1=æœ€é«˜ï¼‰ | `1`, `2`, `3`, `4` |
| `webhook` | TEXT | - | NULL | Webhook URLï¼ˆé€šçŸ¥ç”¨ï¼‰ | `"https://chat.googleapis.com/..."` |
| `is_default` | BOOLEAN | - | false | æ˜¯å¦ç‚ºé è¨­è§’è‰² | `true`, `false` |
| `created_at` | TIMESTAMPTZ | - | NOW() | å»ºç«‹æ™‚é–“ | `2025-12-15 00:00:00+00` |
| `updated_at` | TIMESTAMPTZ | - | NOW() | æ›´æ–°æ™‚é–“ | `2025-12-18 16:00:00+00` |

#### ç´¢å¼•çµæ§‹

```sql
CREATE INDEX idx_roles_level ON roles(level);
CREATE INDEX idx_roles_is_default ON roles(is_default);
CREATE INDEX idx_roles_webhook ON roles(webhook) WHERE webhook IS NOT NULL;
```

**ç´¢å¼•ç”¨é€”**ï¼š
- `idx_roles_level`: å¿«é€ŸæŸ¥è©¢ç‰¹å®šå±¤ç´šçš„è§’è‰²
- `idx_roles_is_default`: å¿«é€ŸæŸ¥æ‰¾é è¨­è§’è‰²
- `idx_roles_webhook`: å¿«é€ŸæŸ¥æ‰¾æœ‰ Webhook çš„è§’è‰²ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰

#### è§¸ç™¼å™¨

**è‡ªå‹•æ›´æ–° updated_at**ï¼š
```sql
CREATE TRIGGER update_roles_updated_at 
  BEFORE UPDATE ON roles
  FOR EACH ROW 
  EXECUTE FUNCTION update_updated_at_column();
```

ç•¶è§’è‰²è³‡æ–™æ›´æ–°æ™‚ï¼Œè‡ªå‹•æ›´æ–° `updated_at` æ¬„ä½ã€‚

#### è³‡æ–™ç¯„ä¾‹

```json
{
  "id": "é™¢é•·",
  "name": "é™¢é•·",
  "icon_name": "Briefcase",
  "color": "bg-blue-100 text-blue-700",
  "level": 1,
  "webhook": null,
  "is_default": false,
  "created_at": "2025-12-15T00:00:00+00:00",
  "updated_at": "2025-12-15T00:00:00+00:00"
}
```

#### API ä½¿ç”¨æ¨¡å¼

**æŸ¥è©¢æ‰€æœ‰è§’è‰²**ï¼š
```typescript
GET /rest/v1/roles
```

**å–å¾—æŽ’åºå¾Œçš„è§’è‰²åˆ—è¡¨**ï¼š
```typescript
GET /rest/v1/roles?order=name.asc
```

**æŸ¥è©¢ç‰¹å®šå±¤ç´šçš„è§’è‰²**ï¼š
```typescript
GET /rest/v1/roles?level=eq.1
```

**æŸ¥è©¢æœ‰ Webhook çš„è§’è‰²**ï¼š
```typescript
GET /rest/v1/roles?webhook=not.is.null
```

---

## ðŸ”— è³‡æ–™è¡¨é—œè¯åˆ†æž

### é—œè¯é—œä¿‚åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     roles       â”‚
â”‚  (è§’è‰²å®šç¾©è¡¨)    â”‚
â”‚                 â”‚
â”‚  id (PK)        â”‚â—„â”€â”€â”€â”€â”€â”€â”
â”‚  name           â”‚       â”‚
â”‚  level          â”‚       â”‚
â”‚  webhook        â”‚       â”‚
â”‚  ...            â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
                           â”‚
                           â”‚ FOREIGN KEY
                           â”‚ users.role â†’ roles.id
                           â”‚ ON DELETE SET NULL
                           â”‚ ON UPDATE CASCADE
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     users        â”‚       â”‚
â”‚  (ç”¨æˆ¶/å“¡å·¥è¡¨)   â”‚       â”‚
â”‚                 â”‚       â”‚
â”‚  id (PK)        â”‚       â”‚
â”‚  name           â”‚       â”‚
â”‚  role (FK) â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  level          â”‚       â”‚
â”‚  Mail           â”‚       â”‚
â”‚  ID4            â”‚       â”‚
â”‚  headshot       â”‚       â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
      â”‚                    â”‚
      â”‚ LOGICAL            â”‚
      â”‚ RELATION           â”‚
      â”‚                    â”‚
      â”‚ tasks.assigner_id â”€â”¤
      â”‚ tasks.assignee_id â”€â”¤
      â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚     tasks        â”‚       â”‚
â”‚  (ä»»å‹™è¡¨)        â”‚       â”‚
â”‚                 â”‚       â”‚
â”‚  id (PK)        â”‚       â”‚
â”‚  title          â”‚       â”‚
â”‚  assigner_id â”€â”€â”€â”˜       â”‚
â”‚  assignee_id â”€â”€â”€â”˜       â”‚
â”‚  status         â”‚       â”‚
â”‚  evidence       â”‚       â”‚
â”‚  ...            â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
```

### é—œè¯è©³ç´°èªªæ˜Ž

#### 1. roles â†” usersï¼ˆä¸€å°å¤šï¼Œå¤–éµé—œè¯ï¼‰

**é—œè¯é¡žåž‹**ï¼šä¸€å°å¤šï¼ˆOne-to-Manyï¼‰

**å¤–éµå®šç¾©**ï¼š
```sql
ALTER TABLE users 
  ADD CONSTRAINT fk_users_role 
  FOREIGN KEY (role) 
  REFERENCES roles(id) 
  ON DELETE SET NULL 
  ON UPDATE CASCADE;
```

**é—œè¯ç‰¹æ€§**ï¼š
- **ä¸€å€‹è§’è‰²**å¯ä»¥å°æ‡‰**å¤šå€‹ç”¨æˆ¶**
- **ä¸€å€‹ç”¨æˆ¶**åªèƒ½æœ‰**ä¸€å€‹è§’è‰²**ï¼ˆæˆ– NULLï¼‰
- ç•¶è§’è‰²è¢«åˆªé™¤æ™‚ï¼Œç›¸é—œç”¨æˆ¶çš„ `role` æœƒè¨­ç‚º NULLï¼ˆä¸æœƒåˆªé™¤ç”¨æˆ¶ï¼‰
- ç•¶è§’è‰² ID æ›´æ–°æ™‚ï¼Œæ‰€æœ‰ç›¸é—œç”¨æˆ¶çš„ `role` æœƒè‡ªå‹•æ›´æ–°

**æŸ¥è©¢ç¯„ä¾‹**ï¼š
```sql
-- æŸ¥è©¢è§’è‰²åŠå…¶ç”¨æˆ¶æ•¸é‡
SELECT 
  r.id,
  r.name,
  COUNT(u.id) as user_count
FROM roles r
LEFT JOIN users u ON u.role = r.id
GROUP BY r.id, r.name
ORDER BY user_count DESC;
```

#### 2. users â†” tasksï¼ˆé‚è¼¯é—œè¯ï¼Œç„¡å¤–éµï¼‰

**é—œè¯é¡žåž‹**ï¼šä¸€å°å¤šï¼ˆOne-to-Manyï¼Œé‚è¼¯é—œè¯ï¼‰

**é—œè¯æ¬„ä½**ï¼š
- `tasks.assigner_id` â†’ `users.id`ï¼ˆäº¤è¾¦äººï¼‰
- `tasks.assignee_id` â†’ `users.id`ï¼ˆæ‰¿è¾¦äººï¼‰

**é—œè¯ç‰¹æ€§**ï¼š
- **ä¸€å€‹ç”¨æˆ¶**å¯ä»¥**äº¤è¾¦å¤šå€‹ä»»å‹™**ï¼ˆä½œç‚º assignerï¼‰
- **ä¸€å€‹ç”¨æˆ¶**å¯ä»¥**æ‰¿è¾¦å¤šå€‹ä»»å‹™**ï¼ˆä½œç‚º assigneeï¼‰
- **ä¸€å€‹ä»»å‹™**æœ‰**ä¸€å€‹äº¤è¾¦äºº**å’Œ**ä¸€å€‹æ‰¿è¾¦äºº**
- æ²’æœ‰å¤–éµç´„æŸï¼Œéœ€è¦æ‡‰ç”¨å±¤ç¶­è­·è³‡æ–™å®Œæ•´æ€§

**æŸ¥è©¢ç¯„ä¾‹**ï¼š
```sql
-- æŸ¥è©¢ç”¨æˆ¶äº¤è¾¦çš„ä»»å‹™
SELECT t.*, u.name as assigner_name
FROM tasks t
JOIN users u ON t.assigner_id = u.id
WHERE u.id = 1;

-- æŸ¥è©¢ç”¨æˆ¶æ‰¿è¾¦çš„ä»»å‹™
SELECT t.*, u.name as assignee_name
FROM tasks t
JOIN users u ON t.assignee_id = u.id
WHERE u.id = 2;
```

---

## ðŸ“Š è³‡æ–™çµ±è¨ˆåˆ†æž

### ç•¶å‰è³‡æ–™é‡

æ ¹æ“šä¹‹å‰çš„åŒ¯å…¥è¨˜éŒ„ï¼š

| è¡¨å | è¨˜éŒ„æ•¸ | è³‡æ–™å¤§å° | èªªæ˜Ž |
|------|--------|---------|------|
| **users** | 114 | ~16KB | ç³»çµ±ä¸­çš„ç”¨æˆ¶/å“¡å·¥ |
| **tasks** | 5 | ~1.1KB | ä»»å‹™äº¤è¾¦è¨˜éŒ„ |
| **roles** | 19 | ~3.1KB | è§’è‰²å®šç¾© |

### è³‡æ–™åˆ†å¸ƒåˆ†æž

#### users è¡¨åˆ†å¸ƒ

**å±¤ç´šåˆ†å¸ƒ**ï¼ˆæŽ¨æ¸¬ï¼‰ï¼š
- Level 1ï¼ˆæœ€é«˜å±¤ï¼‰ï¼šå°‘æ•¸ï¼ˆé™¢é•·ã€å‰¯é™¢é•·ç­‰ï¼‰
- Level 2ï¼ˆä¸­é«˜å±¤ï¼‰ï¼šéƒ¨åˆ†ï¼ˆä¸»ä»»ã€ç¶“ç†ç­‰ï¼‰
- Level 3ï¼ˆä¸­å±¤ï¼‰ï¼šéƒ¨åˆ†ï¼ˆçµ„é•·ã€ä¸»ç®¡ç­‰ï¼‰
- Level 4ï¼ˆå“¡å·¥ï¼‰ï¼šå¤šæ•¸ï¼ˆä¸€èˆ¬å“¡å·¥ï¼‰

**è§’è‰²åˆ†å¸ƒ**ï¼š
- 19 å€‹ä¸åŒçš„è§’è‰²
- æ¯å€‹è§’è‰²å°æ‡‰å¤šå€‹ç”¨æˆ¶

#### tasks è¡¨åˆ†å¸ƒ

**ç‹€æ…‹åˆ†å¸ƒ**ï¼ˆæŽ¨æ¸¬ï¼‰ï¼š
- `pending`: å¾…è™•ç†çš„ä»»å‹™
- `in_progress`: é€²è¡Œä¸­çš„ä»»å‹™
- `done`: å·²å®Œæˆçš„ä»»å‹™
- `overdue`: é€¾æœŸçš„ä»»å‹™

**è§’è‰²é¡žåˆ¥åˆ†å¸ƒ**ï¼š
- ä»»å‹™å¯èƒ½åˆ†é…åˆ°ä¸åŒçš„è§’è‰²é¡žåˆ¥
- ç”¨æ–¼ç¯©é¸å’Œåˆ†é¡ž

---

## ðŸ” æŸ¥è©¢æ•ˆèƒ½åˆ†æž

### å¸¸ç”¨æŸ¥è©¢æ¨¡å¼

#### 1. ç”¨æˆ¶æŸ¥è©¢

**æŸ¥è©¢æ‰€æœ‰ç”¨æˆ¶**ï¼š
```sql
SELECT * FROM users;
```
- **æ•ˆèƒ½**ï¼šO(n)ï¼Œn = ç”¨æˆ¶æ•¸é‡
- **ç´¢å¼•ä½¿ç”¨**ï¼šç„¡ï¼ˆå…¨è¡¨æŽƒæï¼‰

**ä¾è§’è‰²æŸ¥è©¢ç”¨æˆ¶**ï¼š
```sql
SELECT * FROM users WHERE role = 'é™¢é•·';
```
- **æ•ˆèƒ½**ï¼šO(log n) + O(m)ï¼Œm = è©²è§’è‰²çš„ç”¨æˆ¶æ•¸
- **ç´¢å¼•ä½¿ç”¨**ï¼š`idx_users_role`

**ä¾å±¤ç´šæŸ¥è©¢ç”¨æˆ¶**ï¼š
```sql
SELECT * FROM users WHERE level = 1;
```
- **æ•ˆèƒ½**ï¼šO(log n) + O(m)ï¼Œm = è©²å±¤ç´šçš„ç”¨æˆ¶æ•¸
- **ç´¢å¼•ä½¿ç”¨**ï¼š`idx_users_level`

#### 2. ä»»å‹™æŸ¥è©¢

**æŸ¥è©¢æ‰€æœ‰ä»»å‹™**ï¼š
```sql
SELECT * FROM tasks;
```
- **æ•ˆèƒ½**ï¼šO(n)ï¼Œn = ä»»å‹™æ•¸é‡
- **ç´¢å¼•ä½¿ç”¨**ï¼šç„¡ï¼ˆå…¨è¡¨æŽƒæï¼‰

**ä¾è§’è‰²é¡žåˆ¥ç¯©é¸**ï¼š
```sql
SELECT * FROM tasks WHERE role_category = 'ç®¡ç†';
```
- **æ•ˆèƒ½**ï¼šO(log n) + O(m)ï¼Œm = è©²é¡žåˆ¥çš„ä»»å‹™æ•¸
- **ç´¢å¼•ä½¿ç”¨**ï¼š`idx_tasks_role_category`

**ä¾ç‹€æ…‹æŸ¥è©¢**ï¼š
```sql
SELECT * FROM tasks WHERE status = 'pending';
```
- **æ•ˆèƒ½**ï¼šO(log n) + O(m)ï¼Œm = è©²ç‹€æ…‹çš„ä»»å‹™æ•¸
- **ç´¢å¼•ä½¿ç”¨**ï¼š`idx_tasks_status`

**æŸ¥è©¢ç”¨æˆ¶çš„ä»»å‹™**ï¼š
```sql
SELECT * FROM tasks WHERE assignee_id = 1;
```
- **æ•ˆèƒ½**ï¼šO(log n) + O(m)ï¼Œm = è©²ç”¨æˆ¶çš„ä»»å‹™æ•¸
- **ç´¢å¼•ä½¿ç”¨**ï¼š`idx_tasks_assignee_id`

#### 3. è§’è‰²æŸ¥è©¢

**æŸ¥è©¢æ‰€æœ‰è§’è‰²**ï¼š
```sql
SELECT * FROM roles ORDER BY name ASC;
```
- **æ•ˆèƒ½**ï¼šO(n log n)ï¼Œn = è§’è‰²æ•¸é‡ï¼ˆæŽ’åºï¼‰
- **ç´¢å¼•ä½¿ç”¨**ï¼šç„¡ï¼ˆä½†è§’è‰²æ•¸é‡å°‘ï¼Œå½±éŸ¿ä¸å¤§ï¼‰

**æŸ¥è©¢ç‰¹å®šå±¤ç´šçš„è§’è‰²**ï¼š
```sql
SELECT * FROM roles WHERE level = 1;
```
- **æ•ˆèƒ½**ï¼šO(log n) + O(m)ï¼Œm = è©²å±¤ç´šçš„è§’è‰²æ•¸
- **ç´¢å¼•ä½¿ç”¨**ï¼š`idx_roles_level`

---

## ðŸŽ¯ è³‡æ–™è¡¨ä½¿ç”¨å ´æ™¯åˆ†æž

### å ´æ™¯ 1ï¼šå»ºç«‹æ–°ä»»å‹™

**æµç¨‹**ï¼š
1. å‰ç«¯é¸æ“‡äº¤è¾¦äººå’Œæ‰¿è¾¦äººï¼ˆå¾ž users è¡¨ï¼‰
2. é¸æ“‡è§’è‰²é¡žåˆ¥ï¼ˆå¾ž roles è¡¨ï¼‰
3. å»ºç«‹ä»»å‹™è¨˜éŒ„ï¼ˆæ’å…¥ tasks è¡¨ï¼‰

**æ¶‰åŠçš„è³‡æ–™è¡¨**ï¼š
- `users`ï¼ˆæŸ¥è©¢ç”¨æˆ¶åˆ—è¡¨ï¼‰
- `roles`ï¼ˆæŸ¥è©¢è§’è‰²åˆ—è¡¨ï¼‰
- `tasks`ï¼ˆæ’å…¥æ–°è¨˜éŒ„ï¼‰

**API å‘¼å«**ï¼š
```typescript
// 1. å–å¾—ç”¨æˆ¶åˆ—è¡¨
GET /rest/v1/users

// 2. å–å¾—è§’è‰²åˆ—è¡¨
GET /rest/v1/roles

// 3. å»ºç«‹ä»»å‹™
POST /rest/v1/tasks
```

### å ´æ™¯ 2ï¼šæŸ¥çœ‹ä»»å‹™åˆ—è¡¨

**æµç¨‹**ï¼š
1. æ ¹æ“šè§’è‰²é¡žåˆ¥ç¯©é¸ä»»å‹™
2. é¡¯ç¤ºä»»å‹™è³‡è¨Šï¼ˆåŒ…æ‹¬äº¤è¾¦äººã€æ‰¿è¾¦äººï¼‰
3. é¡¯ç¤ºä»»å‹™ç‹€æ…‹

**æ¶‰åŠçš„è³‡æ–™è¡¨**ï¼š
- `tasks`ï¼ˆä¸»è¦æŸ¥è©¢ï¼‰
- `users`ï¼ˆé‚è¼¯é—œè¯ï¼Œå–å¾—ç”¨æˆ¶åç¨±ï¼‰

**API å‘¼å«**ï¼š
```typescript
// æŸ¥è©¢ä»»å‹™ï¼ˆä¾è§’è‰²é¡žåˆ¥ï¼‰
GET /rest/v1/tasks?role_category=eq.ç®¡ç†

// å¦‚æžœéœ€è¦ç”¨æˆ¶è©³ç´°è³‡è¨Šï¼Œå†æŸ¥è©¢
GET /rest/v1/users?id=eq.1
```

### å ´æ™¯ 3ï¼šæ›´æ–°ä»»å‹™ç‹€æ…‹

**æµç¨‹**ï¼š
1. æ‰¿è¾¦äººæ›´æ–°ä»»å‹™ç‹€æ…‹
2. å¯é¸ï¼šæ·»åŠ å›žè¦†æˆ–ä½è­‰è³‡æ–™

**æ¶‰åŠçš„è³‡æ–™è¡¨**ï¼š
- `tasks`ï¼ˆæ›´æ–°è¨˜éŒ„ï¼‰

**API å‘¼å«**ï¼š
```typescript
// æ›´æ–°ä»»å‹™ç‹€æ…‹
PATCH /rest/v1/tasks?id=eq.123
{
  "status": "in_progress",
  "assignee_response": "å·²é–‹å§‹è™•ç†"
}
```

### å ´æ™¯ 4ï¼šè§’è‰²ç®¡ç†

**æµç¨‹**ï¼š
1. æŸ¥çœ‹æ‰€æœ‰è§’è‰²
2. å»ºç«‹/æ›´æ–°/åˆªé™¤è§’è‰²
3. è¨­å®šè§’è‰² Webhook

**æ¶‰åŠçš„è³‡æ–™è¡¨**ï¼š
- `roles`ï¼ˆä¸»è¦æ“ä½œï¼‰
- `users`ï¼ˆæª¢æŸ¥æ˜¯å¦æœ‰ç”¨æˆ¶ä½¿ç”¨è©²è§’è‰²ï¼‰

**API å‘¼å«**ï¼š
```typescript
// å–å¾—æ‰€æœ‰è§’è‰²
GET /rest/v1/roles?order=name.asc

// å»ºç«‹æ–°è§’è‰²
POST /rest/v1/roles

// æ›´æ–°è§’è‰²
PATCH /rest/v1/roles?id=eq.æ–°è§’è‰²
```

---

## ðŸ” å®‰å…¨æ€§åˆ†æž

### Row Level Security (RLS)

æ‰€æœ‰è³‡æ–™è¡¨éƒ½å•Ÿç”¨äº† RLSï¼š

```sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE roles ENABLE ROW LEVEL SECURITY;
```

### ç•¶å‰ RLS æ”¿ç­–

**å¯¬é¬†æ”¿ç­–**ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰ï¼š
```sql
CREATE POLICY "Allow all operations on {table}" ON {table}
  FOR ALL USING (true) WITH CHECK (true);
```

**èªªæ˜Ž**ï¼š
- å…è¨±æ‰€æœ‰äººè®€å¯«
- é©åˆé–‹ç™¼å’Œæ¸¬è©¦ç’°å¢ƒ
- **ç”Ÿç”¢ç’°å¢ƒæ‡‰èª¿æ•´ç‚ºæ›´åš´æ ¼çš„æ”¿ç­–**

### å»ºè­°çš„ç”Ÿç”¢ç’°å¢ƒæ”¿ç­–

**users è¡¨**ï¼š
```sql
-- å…è¨±æ‰€æœ‰äººè®€å–
CREATE POLICY "Allow public read" ON users
  FOR SELECT USING (true);

-- åªå…è¨±èªè­‰ç”¨æˆ¶å¯«å…¥
CREATE POLICY "Allow authenticated insert" ON users
  FOR INSERT WITH CHECK (auth.role() = 'authenticated');
```

**tasks è¡¨**ï¼š
```sql
-- å…è¨±æ‰€æœ‰äººè®€å–
CREATE POLICY "Allow public read" ON tasks
  FOR SELECT USING (true);

-- åªå…è¨±èªè­‰ç”¨æˆ¶å¯«å…¥
CREATE POLICY "Allow authenticated write" ON tasks
  FOR ALL USING (auth.role() = 'authenticated');
```

---

## ðŸ“ˆ è³‡æ–™è¡¨è¨­è¨ˆå„ªåŒ–å»ºè­°

### 1. ç´¢å¼•å„ªåŒ–

**ç¾æœ‰ç´¢å¼•**ï¼šè‰¯å¥½
- å·²é‡å°å¸¸ç”¨æŸ¥è©¢æ¬„ä½å»ºç«‹ç´¢å¼•
- ç´¢å¼•é¸æ“‡åˆç†

**å»ºè­°**ï¼š
- ç›£æŽ§æŸ¥è©¢æ•ˆèƒ½ï¼Œé©æ™‚èª¿æ•´
- å¦‚æžœç¶“å¸¸æŸ¥è©¢ `users.name`ï¼Œå¯è€ƒæ…®å»ºç«‹ç´¢å¼•

### 2. å¤–éµç´„æŸ

**ç¾æœ‰ç´„æŸ**ï¼š
- `users.role` â†’ `roles.id` âœ…

**å»ºè­°**ï¼š
- è€ƒæ…®ç‚º `tasks.assigner_id` å’Œ `tasks.assignee_id` å»ºç«‹å¤–éµç´„æŸ
- é€™å¯ä»¥ç¢ºä¿è³‡æ–™å®Œæ•´æ€§ï¼Œä½†éœ€è¦å…ˆè™•ç†ç¾æœ‰çš„ç„¡æ•ˆè³‡æ–™

### 3. JSONB æ¬„ä½å„ªåŒ–

**collaborator_ids**ï¼š
- ç•¶å‰ï¼š`JSONB DEFAULT '[]'::jsonb`
- å»ºè­°ï¼šè€ƒæ…®å»ºç«‹ GIN ç´¢å¼•ä»¥æ”¯æ´é™£åˆ—æŸ¥è©¢

**evidence**ï¼š
- ç•¶å‰ï¼š`JSONB DEFAULT '[]'::jsonb`
- å»ºè­°ï¼šå¦‚æžœç¶“å¸¸æŸ¥è©¢ç‰¹å®šé¡žåž‹çš„ä½è­‰ï¼Œå¯å»ºç«‹ GIN ç´¢å¼•

### 4. æ™‚é–“æˆ³è¨˜æ¬„ä½

**ç¾æœ‰**ï¼š
- `timestamp`ï¼ˆå»ºç«‹æ™‚é–“ï¼‰
- `updated_at`ï¼ˆroles è¡¨ï¼‰

**å»ºè­°**ï¼š
- è€ƒæ…®ç‚º `tasks` è¡¨æ·»åŠ  `updated_at` æ¬„ä½
- é€™æœ‰åŠ©æ–¼è¿½è¹¤ä»»å‹™çš„æ›´æ–°æ­·å²

---

## ðŸ”§ ç¶­è­·å»ºè­°

### å®šæœŸç¶­è­·ä»»å‹™

1. **è³‡æ–™å‚™ä»½**
   - å®šæœŸå‚™ä»½æ‰€æœ‰è³‡æ–™è¡¨
   - å»ºè­°é »çŽ‡ï¼šæ¯æ—¥æˆ–æ¯é€±

2. **ç´¢å¼•ç¶­è­·**
   - ç›£æŽ§ç´¢å¼•ä½¿ç”¨æƒ…æ³
   - å®šæœŸé‡å»ºç´¢å¼•ï¼ˆå¦‚æžœéœ€è¦ï¼‰

3. **è³‡æ–™æ¸…ç†**
   - æ¸…ç†èˆŠçš„å·²å®Œæˆä»»å‹™ï¼ˆå¦‚æžœéœ€è¦ï¼‰
   - æ¸…ç†ç„¡æ•ˆçš„ç”¨æˆ¶è¨˜éŒ„

4. **æ•ˆèƒ½ç›£æŽ§**
   - ç›£æŽ§æ…¢æŸ¥è©¢
   - å„ªåŒ–å¸¸ç”¨æŸ¥è©¢

### è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥

**å®šæœŸæª¢æŸ¥**ï¼š
```sql
-- æª¢æŸ¥ç„¡æ•ˆçš„è§’è‰²å¼•ç”¨
SELECT u.id, u.name, u.role
FROM users u
WHERE u.role IS NOT NULL 
  AND NOT EXISTS (SELECT 1 FROM roles r WHERE r.id = u.role);

-- æª¢æŸ¥ç„¡æ•ˆçš„ç”¨æˆ¶å¼•ç”¨ï¼ˆtasksï¼‰
SELECT t.id, t.title, t.assigner_id, t.assignee_id
FROM tasks t
WHERE (t.assigner_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM users u WHERE u.id = t.assigner_id))
   OR (t.assignee_id IS NOT NULL AND NOT EXISTS (SELECT 1 FROM users u WHERE u.id = t.assignee_id));
```

---

## ðŸ“š ç›¸é—œ SQL æŸ¥è©¢ç¯„ä¾‹

### å¸¸ç”¨æŸ¥è©¢

**1. æŸ¥è©¢è§’è‰²åŠå…¶ç”¨æˆ¶æ•¸é‡**ï¼š
```sql
SELECT 
  r.id,
  r.name,
  r.level,
  COUNT(u.id) as user_count
FROM roles r
LEFT JOIN users u ON u.role = r.id
GROUP BY r.id, r.name, r.level
ORDER BY r.level ASC, user_count DESC;
```

**2. æŸ¥è©¢ç”¨æˆ¶çš„ä»»å‹™çµ±è¨ˆ**ï¼š
```sql
SELECT 
  u.id,
  u.name,
  COUNT(CASE WHEN t.assigner_id = u.id THEN 1 END) as assigned_count,
  COUNT(CASE WHEN t.assignee_id = u.id THEN 1 END) as received_count,
  COUNT(CASE WHEN t.assignee_id = u.id AND t.status = 'done' THEN 1 END) as completed_count
FROM users u
LEFT JOIN tasks t ON (t.assigner_id = u.id OR t.assignee_id = u.id)
GROUP BY u.id, u.name;
```

**3. æŸ¥è©¢ä»»å‹™ç‹€æ…‹åˆ†å¸ƒ**ï¼š
```sql
SELECT 
  status,
  COUNT(*) as count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) as percentage
FROM tasks
GROUP BY status
ORDER BY count DESC;
```

**4. æŸ¥è©¢é€¾æœŸä»»å‹™**ï¼š
```sql
SELECT 
  t.id,
  t.title,
  t.assignee_name,
  t.final_date,
  CURRENT_DATE - t.final_date as days_overdue
FROM tasks t
WHERE t.status != 'done'
  AND t.final_date IS NOT NULL
  AND t.final_date < CURRENT_DATE
ORDER BY days_overdue DESC;
```

---

## ðŸ“… æœ€å¾Œæ›´æ–°

2025-12-18  
**å°ˆæ¡ˆç‰ˆæœ¬**ï¼šWebToDispatch_2  
**è³‡æ–™åº«ç‰ˆæœ¬**ï¼šSupabase Local Development
