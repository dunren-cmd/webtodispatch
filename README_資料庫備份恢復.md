# 資料庫備份與恢復說明

## 📋 可用腳本

### 1. `db_backup.bat` - 備份資料庫
雙擊此檔案可以備份當前的 Supabase 資料庫。

**功能：**
- 自動檢查 Supabase 服務狀態
- 使用 Docker 容器內的 pg_dump 備份資料庫
- 備份檔案儲存在 `backups` 資料夾
- 備份檔名包含日期時間，例如：`supabase_backup_20241213_1430.sql`

**使用方法：**
1. 確保 Supabase 服務正在運行
2. 雙擊 `db_backup.bat`
3. 等待備份完成
4. 備份檔案會儲存在 `backups` 資料夾中

---

### 2. `db_restore.bat` - 恢復資料庫
雙擊此檔案可以從備份檔案恢復資料庫。

**功能：**
- 列出所有可用的備份檔案
- 自動檢查 Supabase 服務狀態
- 如果服務未啟動，會自動啟動
- 從指定的備份檔案恢復資料

**使用方法：**
1. 雙擊 `db_restore.bat`
2. 查看可用的備份檔案列表
3. 輸入要恢復的備份檔案名稱（或直接按 Enter 使用最新的）
4. 確認恢復操作（輸入 Y）

**注意事項：**
- ⚠️ 恢復操作會覆蓋現有資料！
- 請確保選擇了正確的備份檔案
- 建議在恢復前先執行一次備份

---

### 3. `db_restore_simple.bat` - 簡單恢復（僅結構）
雙擊此檔案可以重置資料庫結構（不包含資料）。

**功能：**
- 執行 `supabase db reset` 來重建資料庫結構
- 只恢復表格結構和遷移，不包含資料

**適用情況：**
- 需要重新建立資料庫結構
- 資料可以從其他地方重新匯入
- 資料庫結構出現問題需要重置

---

### 4. `db_reset.bat` - 重置資料庫
雙擊此檔案可以重置資料庫並執行所有遷移。

**功能：**
- 檢查並啟動 Supabase 服務
- 執行 `supabase db reset`
- 重新執行所有遷移檔案
- 執行 seed 檔案（如果存在）

---

## 🔄 完整備份與恢復流程

### 定期備份
建議定期執行備份，特別是在：
- 重要資料變更後
- 部署前
- 測試新功能前

### 恢復資料庫
1. 執行 `db_backup.bat` 先備份當前狀態（以防萬一）
2. 執行 `db_restore.bat` 選擇要恢復的備份檔案
3. 確認恢復成功

---

## 📁 備份檔案位置

所有備份檔案儲存在 `backups` 資料夾中：
```
WebToDispatch_2/
  └── backups/
      ├── supabase_backup_20241213_1430.sql
      ├── supabase_backup_20241214_0915.sql
      └── ...
```

---

## ⚠️ 注意事項

1. **定期備份**：建議每天或每次重要變更後執行備份
2. **備份檔案大小**：備份檔案可能很大，請確保有足夠的磁碟空間
3. **恢復前確認**：恢復操作會覆蓋現有資料，請務必確認
4. **Docker 運行**：備份和恢復需要 Docker Desktop 正在運行
5. **服務狀態**：確保 Supabase 服務正常運行

---

## 🔧 疑難排解

### 備份失敗
- 確認 Supabase 服務正在運行（執行 `supabase status`）
- 確認 Docker Desktop 正在運行
- 檢查磁碟空間是否足夠

### 恢復失敗
- 確認備份檔案存在且完整
- 確認備份檔案格式正確（.sql 格式）
- 確認 Supabase 服務正在運行
- 檢查 Docker 容器是否正常運行

### 找不到備份檔案
- 確認 `backups` 資料夾存在
- 檢查備份檔案是否被移動或刪除
- 確認備份檔案名稱輸入正確（不含路徑）

---

## 💡 建議

1. **自動備份**：可以設定 Windows 工作排程器定期執行備份
2. **多重備份**：保留多個時間點的備份，避免單點失敗
3. **異地備份**：將重要備份複製到其他位置（雲端、其他硬碟等）
4. **測試恢復**：定期測試恢復流程，確保備份可用

---

## 📞 需要協助？

如果遇到問題：
1. 檢查 Supabase 服務狀態：`supabase status`
2. 檢查 Docker 容器：`docker ps`
3. 查看 Supabase 日誌：`supabase logs db`
4. 參考 `SQL_錯誤排除指南.md` 和 `Supabase_API錯誤排除.md`
