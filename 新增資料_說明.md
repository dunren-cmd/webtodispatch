# 新增資料：一個欄位一個欄位

## 🎯 適用情況

如果 `users` 表中**沒有**與 `PersonnelData` 相同的 `id`，只是要**新增**記錄，使用這個方法。

---

## 📋 執行步驟

### 步驟 1：設定（只需要執行一次）

```sql
ALTER TABLE users ADD COLUMN IF NOT EXISTS mail TEXT;
```

---

### 步驟 2：查看要新增的資料

```sql
SELECT 
  id,
  name,
  role,  -- 已改名為 role
  "Mail"
FROM "PersonnelData"
ORDER BY id;
```

---

### 步驟 3：只新增 name 欄位（新增所有記錄）

#### 方法 A：如果 users 表中完全沒有這些 id

```sql
INSERT INTO users (id, name, timestamp)
SELECT 
  p.id,
  p.name,
  NOW()  -- 直接使用當前時間，因為 PersonnelData 沒有 timestamp 欄位
FROM "PersonnelData" p
WHERE NOT EXISTS (
  SELECT 1 FROM users u WHERE u.id = p.id
);
```

這會：
- 只新增 `users` 表中**不存在**的 `id`
- 只填入 `id`、`name`、`timestamp` 三個欄位
- 其他欄位（`role`、`mail`）會是 `NULL`

#### 方法 B：如果部分 id 已存在，只新增不存在的

```sql
INSERT INTO users (id, name, timestamp)
SELECT 
  p.id,
  p.name,
  NOW()
FROM "PersonnelData" p
ON CONFLICT (id) DO NOTHING;
```

這會：
- 如果 `id` 已存在，**跳過**（不更新也不報錯）
- 如果 `id` 不存在，**新增**

---

### 步驟 4：只更新 role 欄位（更新已存在的記錄）

```sql
UPDATE users u
SET role = p.role  -- PersonnelData 的欄位名稱已改為 role
FROM "PersonnelData" p
WHERE u.id = p.id;
```

這會更新所有已存在記錄的 `role` 欄位。

---

### 步驟 5：只更新 mail 欄位（更新已存在的記錄）

```sql
UPDATE users u
SET mail = p."Mail"
FROM "PersonnelData" p
WHERE u.id = p.id;
```

這會更新所有已存在記錄的 `mail` 欄位。

---

### 步驟 6：最終驗證

```sql
SELECT 
  u.id,
  u.name,
  u.role,
  u.mail,
  p.name as personnel_name,
  p.role as personnel_role,
  p."Mail" as personnel_mail,
  CASE 
    WHEN u.name = p.name AND u.role = p.role AND u.mail = p."Mail" THEN '✅ 全部成功'
    WHEN u.name = p.name AND u.role = p.role THEN '⚠️ mail 未更新'
    WHEN u.name = p.name THEN '⚠️ role 和 mail 未更新'
    ELSE '❌ 未更新'
  END as status
FROM users u
JOIN "PersonnelData" p ON u.id = p.id
ORDER BY u.id;
```

---

## 🔄 完整流程

### 第一次：新增記錄（只包含 id 和 name）

```sql
INSERT INTO users (id, name, timestamp)
SELECT 
  p.id,
  p.name,
  NOW()  -- 直接使用當前時間
FROM "PersonnelData" p
WHERE NOT EXISTS (
  SELECT 1 FROM users u WHERE u.id = p.id
);
```

**結果**：`users` 表中新增了所有記錄，但只有 `id`、`name`、`timestamp` 有值，`role` 和 `mail` 是 `NULL`。

---

### 第二次：更新 role 欄位

```sql
UPDATE users u
SET role = p.role  -- PersonnelData 的欄位名稱已改為 role
FROM "PersonnelData" p
WHERE u.id = p.id;
```

**結果**：所有記錄的 `role` 欄位已更新。

---

### 第三次：更新 mail 欄位

```sql
UPDATE users u
SET mail = p."Mail"
FROM "PersonnelData" p
WHERE u.id = p.id;
```

**結果**：所有記錄的 `mail` 欄位已更新。

---

## ⚠️ 注意事項

1. **步驟 3 只新增 id 和 name**：其他欄位會是 `NULL`，需要後續更新
2. **步驟 4 和 5 是更新**：因為記錄已經存在，所以用 UPDATE
3. **如果 id 已存在**：步驟 3 的 `WHERE NOT EXISTS` 會跳過，不會重複新增

---

## 💡 替代方案：一次新增所有欄位

如果想一次新增所有欄位（不需要分步驟），可以使用：

```sql
INSERT INTO users (id, name, role, mail, timestamp)
SELECT 
  p.id,
  p.name,
  p.role as role,
  p."Mail" as mail,
  NOW()
FROM "PersonnelData" p
WHERE NOT EXISTS (
  SELECT 1 FROM users u WHERE u.id = p.id
);
```

這樣一次就能新增所有欄位，但如果你想要一個欄位一個欄位來，就按照上面的步驟執行。

---

## ✅ 執行順序

1. **步驟 1**：添加 mail 欄位（只需要一次）
2. **步驟 2**：查看 PersonnelData 的資料（確認）
3. **步驟 3**：新增所有記錄（只包含 id 和 name）
4. **步驟 4**：更新所有記錄的 role 欄位
5. **步驟 5**：更新所有記錄的 mail 欄位
6. **步驟 6**：最終驗證
