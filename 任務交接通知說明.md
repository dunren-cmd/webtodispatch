# ä»»å‹™äº¤æ¥ Chat é€šçŸ¥åŠŸèƒ½èªªæ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

ç•¶ä»»å‹™äº¤æ¥ï¼ˆç™¼å¸ƒï¼‰å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•ç™¼é€ Chat é€šçŸ¥ email çµ¦è¢«æŒ‡æ´¾äººã€‚

---

## ğŸ”„ é‹ä½œæµç¨‹

1. **ä»»å‹™å»ºç«‹** â†’ å‘¼å« `saveTask()` å‡½æ•¸
2. **å„²å­˜åˆ° Supabase** â†’ ä»»å‹™è³‡æ–™å¯«å…¥è³‡æ–™åº«
3. **å–å¾—è¢«æŒ‡æ´¾äºº email** â†’ é€é `getUserEmail()` å¾ PersonnelData å–å¾—
4. **ç™¼é€ Chat é€šçŸ¥** â†’ ä½¿ç”¨ `sendChatNotificationEmail()` ç™¼é€ email

---

## ğŸ§ª æ¸¬è©¦æ–¹å¼

### æ–¹æ³•ä¸€ï¼šç›´æ¥æ¸¬è©¦ Chat é€šçŸ¥ï¼ˆæ¨è–¦ï¼‰

åœ¨ Google Apps Script ç·¨è¼¯å™¨ä¸­åŸ·è¡Œï¼š

```javascript
testSendEmailToChimi();
```

**åŠŸèƒ½ï¼š**
- ç›´æ¥ç™¼é€ Chat é€šçŸ¥ email åˆ° `chimi951@gmail.com`
- æ¨¡æ“¬ä»»å‹™äº¤æ¥çš„é€šçŸ¥è¨Šæ¯
- ä¸éœ€è¦å¯¦éš›å»ºç«‹ä»»å‹™

**é æœŸçµæœï¼š**
- âœ… æ”¶åˆ°ä¸€å° Chat é€šçŸ¥ email
- ğŸ“§ æ¨™é¡Œï¼šğŸ’¬ ä¾†è‡ª ç³»çµ±ç®¡ç†å“¡ çš„æ–°è¨Šæ¯
- ğŸ“‹ å…§å®¹åŒ…å«ä»»å‹™æ¨™é¡Œå’Œæè¿°
- ğŸ”— åŒ…å«æŸ¥çœ‹ä»»å‹™çš„é€£çµ

---

### æ–¹æ³•äºŒï¼šå®Œæ•´æµç¨‹æ¸¬è©¦

åœ¨ Google Apps Script ç·¨è¼¯å™¨ä¸­åŸ·è¡Œï¼š

```javascript
testTaskAssignmentWithNotification();
```

**åŠŸèƒ½ï¼š**
- å»ºç«‹ä¸€å€‹æ¸¬è©¦ä»»å‹™
- è‡ªå‹•è§¸ç™¼ Chat é€šçŸ¥
- æ¸¬è©¦å®Œæ•´æµç¨‹

**æ³¨æ„ï¼š**
- éœ€è¦ç¢ºä¿ `assigneeId` å°æ‡‰çš„ç”¨æˆ¶åœ¨ users è¡¨ä¸­æœ‰ `employee_id`
- `employee_id` éœ€è¦å°æ‡‰åˆ° PersonnelData è¡¨ä¸­æœ‰ email çš„è¨˜éŒ„

---

## ğŸ“§ Email å…§å®¹ç¯„ä¾‹

### æ¨™é¡Œ
```
ğŸ’¬ ä¾†è‡ª ç³»çµ±ç®¡ç†å“¡ çš„æ–°è¨Šæ¯
```

### å…§å®¹
```
è¦ªæ„›çš„ æ¸¬è©¦ç”¨æˆ¶ï¼Œ

ç³»çµ±ç®¡ç†å“¡ åœ¨ä»»å‹™ æ¸¬è©¦ä»»å‹™ï¼šç³»çµ±åŠŸèƒ½é©—è­‰ ä¸­ç™¼é€äº†ä¸€å‰‡è¨Šæ¯ï¼š

æ‚¨æœ‰æ–°çš„ä»»å‹™ã€Œæ¸¬è©¦ä»»å‹™ï¼šç³»çµ±åŠŸèƒ½é©—è­‰ã€è¢«æŒ‡æ´¾ã€‚

é€™æ˜¯ä¸€å€‹æ¸¬è©¦ä»»å‹™ï¼Œç”¨ä¾†é©—è­‰ä»»å‹™äº¤æ¥å¾Œçš„ Chat é€šçŸ¥åŠŸèƒ½ã€‚ç•¶ä»»å‹™ç™¼å¸ƒå¾Œï¼Œç³»çµ±æœƒè‡ªå‹•ç™¼é€é€šçŸ¥ email çµ¦è¢«æŒ‡æ´¾äººã€‚

è«‹ç™»å…¥ç³»çµ±æŸ¥çœ‹ä»»å‹™è©³æƒ…ä¸¦é–‹å§‹è™•ç†ã€‚

[æŸ¥çœ‹å®Œæ•´å°è©±] â† å¯é»æ“Šçš„æŒ‰éˆ•
```

---

## âš™ï¸ è¨­å®šè¦æ±‚

### 1. è³‡æ–™åº«é—œè¯

ç¢ºä¿ users å’Œ PersonnelData è¡¨å·²æ­£ç¢ºé—œè¯ï¼š

```sql
-- æª¢æŸ¥ users è¡¨çš„ employee_id æ˜¯å¦è¨­å®š
SELECT id, name, employee_id FROM users;

-- æª¢æŸ¥ PersonnelData è¡¨çš„ email æ˜¯å¦å­˜åœ¨
SELECT employee_id, name, email FROM "PersonnelData";
```

### 2. é—œè¯ users å’Œ PersonnelData

å¦‚æœ users è¡¨ä¸­æ²’æœ‰ employee_idï¼Œéœ€è¦æ‰‹å‹•è¨­å®šï¼š

```sql
-- ç¯„ä¾‹ï¼šå°‡ users.id=2 é—œè¯åˆ° PersonnelData.employee_id='0022'
UPDATE users 
SET employee_id = '0022' 
WHERE id = 2;
```

---

## ğŸ” é™¤éŒ¯èˆ‡æª¢æŸ¥

### æŸ¥çœ‹ Logger æ—¥èªŒ

åœ¨ Google Apps Script ç·¨è¼¯å™¨ä¸­ï¼š
1. åŸ·è¡Œæ¸¬è©¦å‡½æ•¸
2. æŸ¥çœ‹ **Executions** â†’ **Logs**
3. æ‡‰è©²çœ‹åˆ°é¡ä¼¼ä»¥ä¸‹çš„è¨Šæ¯ï¼š

```
âœ… ä»»å‹™å·²æˆåŠŸå„²å­˜åˆ° Supabase
ğŸ“§ Chat é€šçŸ¥å·²ç™¼é€åˆ°ï¼šchimi951@gmail.com
```

### å¸¸è¦‹å•é¡Œ

#### å•é¡Œ 1ï¼šæ‰¾ä¸åˆ°è¢«æŒ‡æ´¾äººçš„ email

**Logger è¨Šæ¯ï¼š**
```
âš ï¸ æ‰¾ä¸åˆ°è¢«æŒ‡æ´¾äºº 2 çš„ emailï¼Œè·³éé€šçŸ¥
```

**åŸå› ï¼š**
- users è¡¨ä¸­æ²’æœ‰ `employee_id`
- PersonnelData è¡¨ä¸­æ²’æœ‰å°æ‡‰çš„ email

**è§£æ±ºæ–¹æ³•ï¼š**
1. æª¢æŸ¥ users è¡¨æ˜¯å¦æœ‰ `employee_id`
2. æª¢æŸ¥ PersonnelData è¡¨æ˜¯å¦æœ‰å°æ‡‰çš„ email
3. ç¢ºèªå…©å€‹è¡¨çš„ `employee_id` å€¼æ˜¯å¦ä¸€è‡´

#### å•é¡Œ 2ï¼šç™¼é€é€šçŸ¥å¤±æ•—ä½†ä¸å½±éŸ¿ä»»å‹™å»ºç«‹

**Logger è¨Šæ¯ï¼š**
```
âš ï¸ ç™¼é€ Chat é€šçŸ¥å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿ä»»å‹™å»ºç«‹ï¼š...
```

**åŸå› ï¼š**
- MailApp æ¬Šé™æœªæˆæ¬Š
- email æ ¼å¼éŒ¯èª¤
- ç¶²è·¯é€£ç·šå•é¡Œ

**è§£æ±ºæ–¹æ³•ï¼š**
1. åŸ·è¡Œ `requestAuthorization()` å‡½æ•¸æˆæ¬Š
2. æª¢æŸ¥ email æ ¼å¼æ˜¯å¦æ­£ç¢º
3. æª¢æŸ¥ç¶²è·¯é€£ç·š

---

## ğŸ“ ç¨‹å¼ç¢¼èªªæ˜

### saveTask å‡½æ•¸ä¸­çš„é€šçŸ¥é‚è¼¯

```javascript
// ç™¼é€ Chat é€šçŸ¥çµ¦è¢«æŒ‡æ´¾äºº
if (taskData.assigneeId) {
  try {
    const assigneeEmail = getUserEmail(taskData.assigneeId);
    if (assigneeEmail) {
      const taskUrl = `http://192.168.68.75:3050?task=${taskId}`;
      const chatUrl = `${taskUrl}&chat=true`;
      const message = `æ‚¨æœ‰æ–°çš„ä»»å‹™ã€Œ${taskData.title}ã€è¢«æŒ‡æ´¾ã€‚${taskData.description ? '\n\n' + taskData.description : ''}`;
      
      sendChatNotificationEmail(
        assigneeEmail,
        assigneeName,
        assignerName,
        message,
        taskData.title,
        chatUrl
      );
    }
  } catch (emailError) {
    // ç™¼é€é€šçŸ¥å¤±æ•—ä¸å½±éŸ¿ä»»å‹™å»ºç«‹
    Logger.log(`âš ï¸ ç™¼é€ Chat é€šçŸ¥å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿ä»»å‹™å»ºç«‹ï¼š${emailError.toString()}`);
  }
}
```

---

## âœ… é©—è­‰æ¸…å–®

- [ ] SQL å·²åŸ·è¡Œï¼ˆä¸²è¯ users å’Œ PersonnelDataï¼‰
- [ ] PersonnelData è¡¨çš„ ID å·²ç”Ÿæˆ
- [ ] users è¡¨æœ‰ employee_id æ¬„ä½
- [ ] users å’Œ PersonnelData å·²æ­£ç¢ºé—œè¯
- [ ] åŸ·è¡Œ `testSendEmailToChimi()` æ¸¬è©¦æˆåŠŸ
- [ ] æª¢æŸ¥ `chimi951@gmail.com` æ”¶åˆ°é€šçŸ¥ email
- [ ] å¯¦éš›å»ºç«‹ä»»å‹™æ™‚ä¹Ÿæœƒç™¼é€é€šçŸ¥

---

## ğŸš€ å¾ŒçºŒå„ªåŒ–

å¯ä»¥è€ƒæ…®æ·»åŠ çš„åŠŸèƒ½ï¼š
- [ ] é€šçŸ¥åå¥½è¨­å®šï¼ˆå…è¨±ç”¨æˆ¶é¸æ“‡æ˜¯å¦æ¥æ”¶ email é€šçŸ¥ï¼‰
- [ ] é€šçŸ¥é »ç‡æ§åˆ¶ï¼ˆé¿å…çŸ­æ™‚é–“å…§ç™¼é€éå¤šé€šçŸ¥ï¼‰
- [ ] é€šçŸ¥æ¨¡æ¿è‡ªè¨‚
- [ ] æ‰¹é‡ä»»å‹™æŒ‡æ´¾çš„é€šçŸ¥å„ªåŒ–

---

**æœ€å¾Œæ›´æ–°ï¼š2025-12-12**
