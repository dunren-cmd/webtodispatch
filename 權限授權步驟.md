# Google Apps Script 權限授權步驟

## 🔴 錯誤訊息

```
Exception: You do not have permission to call UrlFetchApp.fetch. 
Required permissions: https://www.googleapis.com/auth/script.external_request
```

## ✅ 解決步驟（詳細版）

### 步驟 1：執行授權觸發函數

1. **開啟 Google Apps Script 編輯器**
   - 前往 [Google Apps Script](https://script.google.com/)
   - 開啟「任務交辦系統後端」專案

2. **執行 `requestAuthorization` 函數**
   - 在函數下拉選單中選擇 `requestAuthorization`
   - 點擊「執行」按鈕（▶️）
   - **這會觸發授權對話框**

### 步驟 2：完成授權流程

當你點擊「執行」後，會出現以下情況之一：

#### 情況 A：出現授權對話框（正常）

1. **點擊「檢閱權限」**
   - 會開啟新的瀏覽器分頁

2. **選擇 Google 帳號**
   - 選擇執行腳本的 Google 帳號
   - 如果有多個帳號，選擇正確的那個

3. **點擊「進階」**
   - 在授權頁面底部

4. **點擊「前往 [專案名稱]（不安全）」**
   - 這是正常的警告訊息
   - 因為這是未驗證的應用程式

5. **點擊「允許」**
   - 授予應用程式權限

6. **返回 Google Apps Script**
   - 授權完成後，會自動返回編輯器

#### 情況 B：沒有出現授權對話框

**可能原因**：
- 瀏覽器阻擋了彈出視窗
- 已經授權過但權限被撤銷

**解決方案**：
1. **檢查瀏覽器設定**
   - 允許 Google Apps Script 的彈出視窗
   - 或使用無痕模式

2. **手動觸發授權**
   - 點擊編輯器右上角的「授權」按鈕（如果有）
   - 或前往 [Google 帳號設定](https://myaccount.google.com/permissions) 檢查授權狀態

3. **清除授權後重新授權**
   - 前往 [Google 帳號設定](https://myaccount.google.com/permissions)
   - 找到你的 Google Apps Script 專案
   - 點擊「撤銷存取權」
   - 重新執行 `requestAuthorization` 函數

### 步驟 3：確認授權成功

1. **再次執行 `testGeminiAPI` 函數**
   - 應該不會再出現權限錯誤

2. **查看執行記錄**
   - 應該看到「✅ AI 分析完成」
   - 或看到 AI 回應的內容

---

## 🔍 檢查授權狀態

### 方法 1：查看 Google 帳號設定

1. 前往 [Google 帳號設定](https://myaccount.google.com/permissions)
2. 找到「第三方應用程式的存取權」
3. 搜尋你的 Google Apps Script 專案名稱
4. 確認授權狀態

### 方法 2：執行測試函數

1. 執行 `testGeminiAPI` 函數
2. 如果沒有權限錯誤，表示已授權
3. 如果仍有錯誤，需要重新授權

---

## 🛠️ 手動授權（如果自動授權失敗）

### 步驟 1：撤銷現有授權

1. 前往 [Google 帳號設定](https://myaccount.google.com/permissions)
2. 找到你的 Google Apps Script 專案
3. 點擊「撤銷存取權」

### 步驟 2：重新授權

1. 返回 Google Apps Script 編輯器
2. 執行 `requestAuthorization` 函數
3. 完成授權流程

---

## 📝 需要的權限說明

Google Apps Script 需要以下權限：

1. **Google Sheets 存取權**
   - 讀取和寫入試算表資料
   - 權限範圍：`https://www.googleapis.com/auth/spreadsheets`

2. **外部 API 請求權限**
   - 調用 Gemini API 和其他外部服務
   - 權限範圍：`https://www.googleapis.com/auth/script.external_request`
   - **這是導致錯誤的權限**

---

## ⚠️ 常見問題

### Q1: 授權對話框沒有出現

**解決方案**：
1. 檢查瀏覽器是否阻擋彈出視窗
2. 嘗試使用無痕模式
3. 清除瀏覽器快取
4. 確認使用的是正確的 Google 帳號

### Q2: 授權後仍然出現錯誤

**解決方案**：
1. 確認授權流程已完成（看到「允許」按鈕並點擊）
2. 確認使用的是正確的 Google 帳號
3. 嘗試撤銷授權後重新授權
4. 重新部署 Web App

### Q3: 如何確認已授權

**檢查方法**：
1. 執行 `requestAuthorization` 函數
2. 如果看到「✅ 授權成功」，表示已授權
3. 執行 `testGeminiAPI` 函數
4. 如果沒有權限錯誤，表示已授權

---

## 🎯 快速檢查清單

- [ ] 已執行 `requestAuthorization` 函數
- [ ] 已點擊「檢閱權限」
- [ ] 已選擇正確的 Google 帳號
- [ ] 已點擊「進階」→「前往 [專案名稱]（不安全）」
- [ ] 已點擊「允許」
- [ ] 已返回 Google Apps Script 編輯器
- [ ] 再次執行 `testGeminiAPI` 函數沒有錯誤

---

## 📞 如果仍然無法授權

請嘗試以下步驟：

1. **清除瀏覽器快取和 Cookie**
2. **使用無痕模式**
3. **確認 Google 帳號設定**
4. **檢查是否有其他安全設定阻擋**

如果以上步驟都無法解決，請提供：
- 執行記錄的完整內容
- 瀏覽器 Console 的錯誤訊息（如果有）
- 授權頁面的截圖（如果有的話）

