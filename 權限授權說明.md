# Google Apps Script 權限授權說明

## 🔴 錯誤訊息

```
Exception: 你沒有呼叫「UrlFetchApp.fetch」的權限。必要權限：https://www.googleapis.com/auth/script.external_request
```

## 📋 解決步驟

### 步驟 1：觸發權限請求

當 Google Apps Script 首次調用外部 API 時，會自動要求授權。有幾種方式可以觸發：

#### 方法 A：執行測試函數（推薦）

1. 在 Google Apps Script 編輯器中
2. 選擇 `testGeminiAPI` 函數
3. 點擊「執行」
4. 會彈出授權對話框

#### 方法 B：透過 Web App 觸發

1. 在前端應用程式中使用 AI 分析功能
2. 首次調用時會要求授權

### 步驟 2：授權應用程式

1. **點擊「檢閱權限」**
   - 會開啟授權頁面

2. **選擇 Google 帳號**
   - 選擇執行腳本的 Google 帳號

3. **點擊「進階」**
   - 在授權頁面底部

4. **點擊「前往 [專案名稱]（不安全）」**
   - 這是正常的警告，因為這是未驗證的應用程式

5. **點擊「允許」**
   - 授予應用程式權限

### 步驟 3：確認授權

授權完成後，應該可以正常使用 AI 功能。

---

## 🔍 檢查授權狀態

### 方法 1：查看專案設定

1. 點擊「專案設定」（⚙️ 圖示）
2. 查看「OAuth 同意畫面」區塊
3. 確認授權狀態

### 方法 2：執行測試函數

1. 執行 `testGeminiAPI` 函數
2. 如果沒有彈出授權對話框，表示已經授權
3. 查看執行記錄確認功能正常

---

## ⚠️ 常見問題

### Q1: 授權對話框沒有出現

**可能原因**：
- 已經授權過
- 瀏覽器阻擋了彈出視窗

**解決方案**：
1. 檢查瀏覽器是否阻擋彈出視窗
2. 嘗試清除瀏覽器快取
3. 使用無痕模式測試

### Q2: 授權後仍然出現錯誤

**可能原因**：
- 授權未完成
- 使用了錯誤的 Google 帳號

**解決方案**：
1. 確認授權流程已完成
2. 確認使用的是正確的 Google 帳號
3. 嘗試撤銷授權後重新授權

### Q3: 如何撤銷授權

1. 前往 [Google 帳號設定](https://myaccount.google.com/)
2. 點擊「安全性」
3. 找到「第三方應用程式的存取權」
4. 找到你的 Google Apps Script 專案
5. 點擊「撤銷存取權」
6. 重新執行函數以觸發新的授權請求

---

## 📝 需要的權限

Google Apps Script 需要以下權限：

1. **Google Sheets 存取權**
   - 讀取和寫入試算表資料

2. **外部 API 請求權限**（`script.external_request`）
   - 調用 Gemini API
   - 這是導致錯誤的權限

---

## 🎯 快速解決方案

1. **執行測試函數觸發授權**：
   - 選擇 `testGeminiAPI` 函數
   - 點擊「執行」
   - 完成授權流程

2. **確認授權完成**：
   - 再次執行測試函數
   - 應該不會再出現權限錯誤

3. **測試 AI 功能**：
   - 在前端使用 AI 分析功能
   - 應該可以正常工作

---

## 📞 需要協助？

如果授權後仍然出現錯誤，請：
1. 查看執行記錄的完整錯誤訊息
2. 確認是否使用了正確的 Google 帳號
3. 嘗試撤銷並重新授權

