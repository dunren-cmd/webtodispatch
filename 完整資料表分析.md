# WebToDispatch å®Œæ•´è³‡æ–™è¡¨åˆ†æå ±å‘Š

## ğŸ“Š è³‡æ–™è¡¨ç¸½è¦½

æ ¹æ“š Supabase API å®šç¾©ï¼Œå°ˆæ¡ˆä¸­åŒ…å«ä»¥ä¸‹è³‡æ–™è¡¨ï¼š

| è¡¨å | é¡å‹ | ç”¨é€” | ç‹€æ…‹ |
|------|------|------|------|
| **users** | è¡¨ | ç”¨æˆ¶/å“¡å·¥è³‡æ–™ | âœ… ä¸»è¦ä½¿ç”¨ |
| **tasks** | è¡¨ | ä»»å‹™äº¤è¾¦è¨˜éŒ„ | âœ… ä¸»è¦ä½¿ç”¨ |
| **roles** | è¡¨ | è§’è‰²å®šç¾© | âœ… ä¸»è¦ä½¿ç”¨ |

---

## ğŸ“‹ æ ¸å¿ƒè³‡æ–™è¡¨è©³ç´°åˆ†æ

### 1. usersï¼ˆç”¨æˆ¶è¡¨ï¼‰- ä¸»è¦è¡¨

#### å¯¦éš›æ¬„ä½çµæ§‹ï¼ˆå¾ API å®šç¾©ï¼‰

| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
|---------|------|------|
| `id` | BIGINT | ç”¨æˆ¶å”¯ä¸€è­˜åˆ¥ç¢¼ï¼ˆä¸»éµï¼‰ |
| `timestamp` | TIMESTAMPTZ | å»ºç«‹æ™‚é–“æˆ³è¨˜ |
| `name` | TEXT | ç”¨æˆ¶å§“å |
| `role` | TEXT | è§’è‰²IDï¼ˆå¤–éµ â†’ roles.idï¼‰ |
| `employee_id` | TEXT | å“¡å·¥ID |
| `mail` | TEXT | é›»å­éƒµä»¶åœ°å€ |
| `headshot` | TEXT | é ­åƒ/ç…§ç‰‡é€£çµ |
| `level` | INTEGER | å±¤ç´šï¼ˆ1-4ï¼‰ |

**æ³¨æ„**ï¼šå¯¦éš›è³‡æ–™åº«ä¸­æ¬„ä½åç¨±å¯èƒ½æ˜¯ `Mail` å’Œ `ID4`ï¼ˆå¤§å¯«ï¼‰ï¼Œä½† API è¿”å›æ™‚æœƒè½‰æ›ç‚ºå°å¯«ã€‚

#### ç´¢å¼•

- `idx_users_level` - å±¤ç´šç´¢å¼•
- `idx_users_mail` - é›»å­éƒµä»¶ç´¢å¼•
- `idx_users_employee_id` - å“¡å·¥IDç´¢å¼•
- `idx_users_role` - è§’è‰²ç´¢å¼•

#### å¤–éµç´„æŸ

```sql
FOREIGN KEY (role) REFERENCES roles(id) 
ON DELETE SET NULL 
ON UPDATE CASCADE
```

---

### 2. tasksï¼ˆä»»å‹™è¡¨ï¼‰- ä¸»è¦è¡¨

#### å¯¦éš›æ¬„ä½çµæ§‹

| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
|---------|------|------|
| `id` | BIGINT | ä»»å‹™å”¯ä¸€è­˜åˆ¥ç¢¼ï¼ˆä¸»éµï¼‰ |
| `timestamp` | TIMESTAMPTZ | å»ºç«‹æ™‚é–“æˆ³è¨˜ |
| `title` | TEXT | ä»»å‹™æ¨™é¡Œï¼ˆå¿…å¡«ï¼‰ |
| `description` | TEXT | ä»»å‹™æè¿° |
| `assigner_id` | BIGINT | äº¤è¾¦äººID |
| `assigner_name` | TEXT | äº¤è¾¦äººå§“å |
| `assignee_id` | BIGINT | æ‰¿è¾¦äººID |
| `assignee_name` | TEXT | æ‰¿è¾¦äººå§“å |
| `collaborator_ids` | JSONB | å”ä½œè€…IDåˆ—è¡¨ |
| `role_category` | TEXT | è§’è‰²é¡åˆ¥ |
| `plan_date` | DATE | è¨ˆåŠƒæ—¥æœŸ |
| `interim_date` | DATE | æœŸä¸­æª¢æŸ¥æ—¥æœŸ |
| `final_date` | DATE | æœ€çµ‚å®Œæˆæ—¥æœŸ |
| `status` | TEXT | ä»»å‹™ç‹€æ…‹ |
| `assignee_response` | TEXT | æ‰¿è¾¦äººå›è¦† |
| `evidence` | JSONB | ä½è­‰è³‡æ–™ |

#### ç´¢å¼•

- `idx_tasks_role_category` - è§’è‰²é¡åˆ¥ç´¢å¼•
- `idx_tasks_status` - ç‹€æ…‹ç´¢å¼•
- `idx_tasks_assignee_id` - æ‰¿è¾¦äººIDç´¢å¼•
- `idx_tasks_assigner_id` - äº¤è¾¦äººIDç´¢å¼•

---

### 3. rolesï¼ˆè§’è‰²è¡¨ï¼‰- ä¸»è¦è¡¨

#### å¯¦éš›æ¬„ä½çµæ§‹

| æ¬„ä½åç¨± | é¡å‹ | èªªæ˜ |
|---------|------|------|
| `id` | TEXT | è§’è‰²IDï¼ˆä¸»éµï¼‰ |
| `name` | TEXT | è§’è‰²åç¨±ï¼ˆå¿…å¡«ï¼‰ |
| `icon_name` | TEXT | åœ–ç¤ºåç¨± |
| `color` | TEXT | é¡è‰²ä¸»é¡Œ |
| `level` | INTEGER | å±¤ç´šï¼ˆ1-4ï¼‰ |
| `webhook` | TEXT | Webhook URL |
| `is_default` | BOOLEAN | æ˜¯å¦ç‚ºé è¨­è§’è‰² |
| `created_at` | TIMESTAMPTZ | å»ºç«‹æ™‚é–“ |
| `updated_at` | TIMESTAMPTZ | æ›´æ–°æ™‚é–“ |

#### ç´¢å¼•

- `idx_roles_level` - å±¤ç´šç´¢å¼•
- `idx_roles_is_default` - é è¨­è§’è‰²ç´¢å¼•
- `idx_roles_webhook` - Webhookç´¢å¼•ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰

---


## ğŸ”— è³‡æ–™è¡¨é—œè¯åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   roles     â”‚ (è§’è‰²å®šç¾©è¡¨)
â”‚             â”‚
â”‚  id (PK)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ FOREIGN KEY
       â”‚ users.role â†’ roles.id
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   users     â”‚ (ç”¨æˆ¶è¡¨)
â”‚             â”‚
â”‚  id (PK)    â”‚
â”‚  role (FK)  â”‚
â”‚  ...        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ LOGICAL RELATION
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   tasks     â”‚ (ä»»å‹™è¡¨)
â”‚             â”‚
â”‚  id (PK)    â”‚
â”‚  assigner_id â†’ users.id
â”‚  assignee_id â†’ users.id
â”‚  ...        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š è³‡æ–™è¡¨ä½¿ç”¨å„ªå…ˆç´š

### ä¸»è¦ä½¿ç”¨çš„è¡¨ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

1. **users** - ç”¨æˆ¶ç®¡ç†
2. **tasks** - ä»»å‹™ç®¡ç†
3. **roles** - è§’è‰²ç®¡ç†

---

## ğŸ¯ API ç«¯é»å°ç…§è¡¨

### users è¡¨ API

| æ–¹æ³• | ç«¯é» | åŠŸèƒ½ |
|------|------|------|
| GET | `/rest/v1/users` | å–å¾—æ‰€æœ‰ç”¨æˆ¶ |
| GET | `/rest/v1/users?select=role` | å–å¾—è§’è‰²åˆ—è¡¨ |
| GET | `/rest/v1/users?id=eq.{id}` | å–å¾—å–®ä¸€ç”¨æˆ¶ |
| POST | `/rest/v1/users` | å»ºç«‹æ–°ç”¨æˆ¶ |
| PATCH | `/rest/v1/users?id=eq.{id}` | æ›´æ–°ç”¨æˆ¶ |
| DELETE | `/rest/v1/users?id=eq.{id}` | åˆªé™¤ç”¨æˆ¶ |

### tasks è¡¨ API

| æ–¹æ³• | ç«¯é» | åŠŸèƒ½ |
|------|------|------|
| GET | `/rest/v1/tasks` | å–å¾—æ‰€æœ‰ä»»å‹™ |
| GET | `/rest/v1/tasks?role_category=eq.{cat}` | ä¾è§’è‰²é¡åˆ¥ç¯©é¸ |
| GET | `/rest/v1/tasks?status=eq.{status}` | ä¾ç‹€æ…‹ç¯©é¸ |
| GET | `/rest/v1/tasks?assignee_id=eq.{id}` | æŸ¥è©¢æ‰¿è¾¦äººçš„ä»»å‹™ |
| POST | `/rest/v1/tasks` | å»ºç«‹æ–°ä»»å‹™ |
| PATCH | `/rest/v1/tasks?id=eq.{id}` | æ›´æ–°ä»»å‹™ |
| DELETE | `/rest/v1/tasks?id=eq.{id}` | åˆªé™¤ä»»å‹™ |

### roles è¡¨ API

| æ–¹æ³• | ç«¯é» | åŠŸèƒ½ |
|------|------|------|
| GET | `/rest/v1/roles` | å–å¾—æ‰€æœ‰è§’è‰² |
| GET | `/rest/v1/roles?order=name.asc` | å–å¾—æ’åºå¾Œçš„è§’è‰² |
| POST | `/rest/v1/roles` | å»ºç«‹æ–°è§’è‰² |
| PATCH | `/rest/v1/roles?id=eq.{id}` | æ›´æ–°è§’è‰² |
| DELETE | `/rest/v1/roles?id=eq.{id}` | åˆªé™¤è§’è‰² |

---

## ğŸ“ˆ è³‡æ–™è¡¨çµ±è¨ˆ

### ç•¶å‰è³‡æ–™é‡ï¼ˆæ ¹æ“šåŒ¯å…¥è¨˜éŒ„ï¼‰

| è¡¨å | è¨˜éŒ„æ•¸ | èªªæ˜ |
|------|--------|------|
| users | 114 | ç”¨æˆ¶/å“¡å·¥ |
| tasks | 5 | ä»»å‹™è¨˜éŒ„ |
| roles | 19 | è§’è‰²å®šç¾© |

### è³‡æ–™å®Œæ•´æ€§

**users è¡¨**ï¼š
- æ‰€æœ‰ç”¨æˆ¶éƒ½æœ‰ `name`ï¼ˆå¿…å¡«ï¼‰
- éƒ¨åˆ†ç”¨æˆ¶æœ‰ `role`ï¼ˆå¤–éµåˆ° rolesï¼‰
- éƒ¨åˆ†ç”¨æˆ¶æœ‰ `Mail` å’Œ `ID4`

**tasks è¡¨**ï¼š
- æ‰€æœ‰ä»»å‹™éƒ½æœ‰ `title`ï¼ˆå¿…å¡«ï¼‰
- ä»»å‹™ç‹€æ…‹é è¨­ç‚º `pending`
- ä½è­‰è³‡æ–™ä½¿ç”¨ JSONB æ ¼å¼

**roles è¡¨**ï¼š
- æ‰€æœ‰è§’è‰²éƒ½æœ‰ `id` å’Œ `name`ï¼ˆå¿…å¡«ï¼‰
- éƒ¨åˆ†è§’è‰²æœ‰ `webhook` è¨­å®š

---

## ğŸ” æŸ¥è©¢ç¯„ä¾‹

### 1. æŸ¥è©¢è§’è‰²åŠå…¶ç”¨æˆ¶æ•¸é‡

```sql
SELECT 
  r.id,
  r.name,
  r.level,
  COUNT(u.id) as user_count
FROM roles r
LEFT JOIN users u ON u.role = r.id
GROUP BY r.id, r.name, r.level
ORDER BY r.level ASC, user_count DESC;
```

### 2. æŸ¥è©¢ç”¨æˆ¶çš„ä»»å‹™çµ±è¨ˆ

```sql
SELECT 
  u.id,
  u.name,
  u.role,
  COUNT(DISTINCT CASE WHEN t.assigner_id = u.id THEN t.id END) as assigned_count,
  COUNT(DISTINCT CASE WHEN t.assignee_id = u.id THEN t.id END) as received_count,
  COUNT(DISTINCT CASE WHEN t.assignee_id = u.id AND t.status = 'done' THEN t.id END) as completed_count
FROM users u
LEFT JOIN tasks t ON (t.assigner_id = u.id OR t.assignee_id = u.id)
GROUP BY u.id, u.name, u.role;
```

### 3. æŸ¥è©¢ä»»å‹™ç‹€æ…‹åˆ†å¸ƒ

```sql
SELECT 
  status,
  COUNT(*) as count,
  ROUND(COUNT(*) * 100.0 / SUM(COUNT(*)) OVER (), 2) as percentage
FROM tasks
GROUP BY status
ORDER BY count DESC;
```

### 4. æŸ¥è©¢é€¾æœŸä»»å‹™

```sql
SELECT 
  t.id,
  t.title,
  t.assignee_name,
  t.final_date,
  CURRENT_DATE - t.final_date as days_overdue
FROM tasks t
WHERE t.status != 'done'
  AND t.final_date IS NOT NULL
  AND t.final_date < CURRENT_DATE
ORDER BY days_overdue DESC;
```

---

## ğŸ” å®‰å…¨æ€§åˆ†æ

### Row Level Security (RLS)

æ‰€æœ‰ä¸»è¦è¡¨éƒ½å•Ÿç”¨äº† RLSï¼š
- âœ… users
- âœ… tasks
- âœ… roles

### ç•¶å‰æ”¿ç­–

**å¯¬é¬†æ”¿ç­–**ï¼ˆé–‹ç™¼ç’°å¢ƒï¼‰ï¼š
```sql
CREATE POLICY "Allow all operations on {table}" ON {table}
  FOR ALL USING (true) WITH CHECK (true);
```

**å»ºè­°**ï¼šç”Ÿç”¢ç’°å¢ƒæ‡‰èª¿æ•´ç‚ºæ›´åš´æ ¼çš„æ”¿ç­–ã€‚

---

## ğŸ“ è³‡æ–™è¡¨è¨­è¨ˆç‰¹é»

### å„ªé»

1. âœ… **æ¸…æ™°çš„é—œè¯**ï¼šroles â†” users æœ‰æ˜ç¢ºçš„å¤–éµé—œè¯
2. âœ… **éˆæ´»çš„çµæ§‹**ï¼šä½¿ç”¨ JSONB å„²å­˜è¤‡é›œè³‡æ–™
3. âœ… **å®Œæ•´çš„ç´¢å¼•**ï¼šé‡å°å¸¸ç”¨æŸ¥è©¢å»ºç«‹ç´¢å¼•
4. âœ… **æ™‚é–“æˆ³è¨˜**ï¼šè¿½è¹¤è³‡æ–™å»ºç«‹æ™‚é–“

### æ³¨æ„äº‹é …

1. âš ï¸ **å¤–éµç´„æŸ**ï¼šusers.role å¿…é ˆå­˜åœ¨æ–¼ roles.id
2. âš ï¸ **JSONB æ ¼å¼**ï¼šcollaborator_ids å’Œ evidence éœ€è¦æ­£ç¢ºçš„ JSON
3. âš ï¸ **ç‹€æ…‹å€¼**ï¼štasks.status æ‡‰ä½¿ç”¨é å®šç¾©å€¼
4. âš ï¸ **å±¤ç´šç¯„åœ**ï¼šlevel å¿…é ˆåœ¨ 1-4 ç¯„åœå…§

---

## ğŸ”§ å„ªåŒ–å»ºè­°

### 1. ç´¢å¼•å„ªåŒ–

**ç¾æœ‰ç´¢å¼•**ï¼šè‰¯å¥½
- å·²é‡å°å¸¸ç”¨æŸ¥è©¢æ¬„ä½å»ºç«‹ç´¢å¼•

**å»ºè­°**ï¼š
- ç›£æ§æŸ¥è©¢æ•ˆèƒ½
- å¦‚æœç¶“å¸¸æŸ¥è©¢ `users.name`ï¼Œå¯è€ƒæ…®å»ºç«‹ç´¢å¼•

### 2. å¤–éµç´„æŸ

**å»ºè­°**ï¼š
- è€ƒæ…®ç‚º `tasks.assigner_id` å’Œ `tasks.assignee_id` å»ºç«‹å¤–éµç´„æŸ
- ç¢ºä¿è³‡æ–™å®Œæ•´æ€§

### 3. JSONB å„ªåŒ–

**å»ºè­°**ï¼š
- å¦‚æœç¶“å¸¸æŸ¥è©¢ JSONB æ¬„ä½å…§å®¹ï¼Œå¯å»ºç«‹ GIN ç´¢å¼•

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [è³‡æ–™è¡¨åˆ†æå ±å‘Š](./è³‡æ–™è¡¨åˆ†æå ±å‘Š.md) - åŸºç¤åˆ†æ
- [è³‡æ–™è¡¨æ·±åº¦åˆ†æ](./è³‡æ–™è¡¨æ·±åº¦åˆ†æ.md) - æ·±åº¦åˆ†æ
- [è³‡æ–™åº«çµæ§‹](./supabase_schema.sql)
- [é·ç§»æ–‡ä»¶](./supabase/migrations/)

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-12-18  
**å°ˆæ¡ˆç‰ˆæœ¬**ï¼šWebToDispatch_2
